!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.create_whiteboard={})}(this,function(e){"use strict";var Q="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function t(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function n(e,t){return e(t={exports:{}},t.exports),t.exports}var r=n(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function r(e,t,n){this._container=e,this._wb=t,this._tools=[],this._curTool=null,this._direction=n,this._strokeColor="#000000",this._fillColor="#ffffff",this.create(this._container)}return r.prototype.create=function(e){(this._container=e).style.display="flex",e.style.flexDirection=this._direction,e.style.flexWrap="wrap",e.style.justifyContent="flex-start",e.style.alignItems="flex-start",e.style.alignContent="flex-start"},r.prototype.loadTools=function(e){var i=this;e.forEach(function(e){i._tools.push(e);var t=parseInt(e.fontSize||"60",10)+10,o=document.createElement("div");o.classList.add("flex-h","flex-align-x-center","flex-align-y-center"),e.elementId="toolbutton-"+r.uniqueId++,o.classList.add("toolbutton"),o.id=e.elementId,o.style.width=t+"px",o.style.height=t+"px",o.setAttribute("toolIndex",String(i._tools.length-1));var n=document.createElement("i");n.style.fontSize=e.fontSize||"60px",n.style.color="#fff",n.style.lineHeight=e.fontSize||"60px",e.iconClass&&e.iconClass.split(" ").forEach(function(e){n.classList.add(e)}),o.appendChild(n),i._container.appendChild(o),o.addEventListener("click",function(){var e=Number(o.getAttribute("toolIndex")),t=i._tools[e];if(t!==i._curTool&&i._curTool){var n=document.querySelector("#"+i._curTool.elementId);n&&n.classList.remove("active"),i._curTool=null}if(t){var r=document.querySelector("#"+t.elementId);r&&r.classList.add("active"),i._curTool=t}})})},r.prototype.unloadTools=function(){for(;this._container.hasChildNodes();)this._container.removeChild(this._container.firstChild);this._tools=[]},r.uniqueId=1,r}();t.WBEditorToolbox=n});t(r);r.WBEditorToolbox;var v=n(function(e,t){function n(e){return e.x*e.x+e.y*e.y}function r(e){return Math.sqrt(n(e))}function o(e,t){return{x:t.x-e.x,y:t.y-e.y}}Object.defineProperty(t,"__esModule",{value:!0}),t.GetTopLeft=function(e){return{x:e.x,y:e.y}},t.GetTopRight=function(e){return{x:e.x+e.w,y:e.y}},t.GetBottomLeft=function(e){return{x:e.x,y:e.y+e.h}},t.GetBottomRight=function(e){return{x:e.x+e.w,y:e.y+e.h}},t.Normalize=function(e){var t=r(e);1e-4<t&&(e.x/=t,e.y/=t)},t.VectorLengthSq=n,t.VectorLength=r,t.DistanceSq=function(e,t){return n(o(e,t))},t.Distance=function(e,t){return r(o(e,t))},t.DotProduct=function(e,t){return e.x*t.x+e.y*t.y},t.CrossProduct=function(e,t){return e.x*t.y-e.y*t.x},t.GetVector=o,t.ClampPoint=function(e,t,n){return{x:Math.max(t.x,Math.min(n.x,e.x)),y:Math.max(t.y,Math.min(n.y,e.y))}}});t(v);v.GetTopLeft,v.GetTopRight,v.GetBottomLeft,v.GetBottomRight,v.Normalize,v.VectorLengthSq,v.VectorLength,v.DistanceSq,v.Distance,v.DotProduct,v.CrossProduct,v.GetVector,v.ClampPoint;var i=n(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(e){this.type=e};t.BoundingShape=n});t(i);i.BoundingShape;var g=n(function(e,t){var r,o=Q&&Q.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var n=function(n){function r(e){var t=n.call(this,r.type)||this;return t._points=e||[],t._boundingbox=null,t._dirtyFlag=0<t._points.length,t}return o(r,n),r.prototype.addPoint=function(e){this._points.push(e),this._dirtyFlag=!0},Object.defineProperty(r.prototype,"length",{get:function(){return this._points.length},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"boundingbox",{get:function(){return this._checkDirty(),this._boundingbox},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"points",{get:function(){return this._checkDirty(),this._points},enumerable:!0,configurable:!0}),r.prototype.getPoint=function(e){return this._checkDirty(),this._points[e]},r.prototype.removePoint=function(e){this._points.splice(e,1),0===this._points.length?(this._boundingbox=null,this._dirtyFlag=!1):this._dirtyFlag=!0},r.prototype.clear=function(){this._points.length=0,this._boundingbox=null,this._dirtyFlag=!1},r.prototype.getBoundingbox=function(){return this.boundingbox},r.prototype.getTransformedShape=function(t){return new r(t?this._points.map(function(e){return t.transformPoint(e)}):this._points)},r.prototype._checkDirty=function(){this._dirtyFlag&&(this._dirtyFlag=!1,this._adjustPoints(),this._computeBoundingbox())},r.prototype._adjustPoints=function(){var e=this._points.length;if(!(e<3)){for(var t=[this._points[0],this._points[1]],n=2;n<e;n++){for(var r=t.length-1;0<r;){var o=v.GetVector(t[0],t[r]),i=v.GetVector(t[0],this._points[n]),a=v.CrossProduct(o,i);if(a<0){t.splice(r+1,0,this._points[n]);break}if(0===a&&v.VectorLengthSq(i)>v.VectorLengthSq(o)){t.splice(r+1,0,this._points[n]);break}r--}0===r&&t.splice(1,0,this._points[n])}this._points=t}},r.prototype._computeBoundingbox=function(){if(0<this._points.length){var r=this._points[0].x,o=this._points[0].y,i=r,a=o;this._points.forEach(function(e){var t=e.x,n=e.y;t<r?r=t:i<t&&(i=t),n<o?o=n:a<n&&(a=n)}),this._boundingbox={x:r,y:o,w:i-r+1,h:a-o+1}}else this._boundingbox=null},r.type="Hull",r}(i.BoundingShape);t.BoundingHull=n});t(g);g.BoundingHull;var m=n(function(e,t){var r,o=Q&&Q.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var n=function(n){function i(e){var t=n.call(this,i.type)||this;return t.rect=e||null,t}return o(i,n),i.prototype.getBoundingbox=function(){return this.rect},i.prototype.getTransformedShape=function(e){if(null===this.rect)return null;if(e){var t={x:this.rect.x,y:this.rect.y},n={x:this.rect.x,y:this.rect.y+this.rect.h-1},r={x:this.rect.x+this.rect.w-1,y:this.rect.y+this.rect.h-1},o={x:this.rect.x+this.rect.w-1,y:this.rect.y};return new g.BoundingHull([e.transformPoint(t),e.transformPoint(n),e.transformPoint(r),e.transformPoint(o)])}return new i(this.rect)},i.type="Box",i}(i.BoundingShape);t.BoundingBox=n});t(m);m.BoundingBox;var _=n(function(e,t){var r,o=Q&&Q.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var n=function(n){function r(e){var t=n.call(this,r.type)||this;return t._segment=e||null,t._dirty=!!e,t._boundingbox=null,t}return o(r,n),Object.defineProperty(r.prototype,"start",{get:function(){return this._segment?this._segment.start:null},set:function(e){e&&(this._segment?this._segment.start=e:this._segment={start:e,end:e},this._dirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"end",{get:function(){return this._segment?this._segment.end:null},set:function(e){e&&(this._segment?this._segment.end=e:this._segment={start:e,end:e},this._dirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"segment",{get:function(){return this._segment?{start:this.start,end:this.end}:null},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"boundingbox",{get:function(){return this._checkDirty(),this._boundingbox},enumerable:!0,configurable:!0}),r.prototype.getBoundingbox=function(){return this.boundingbox},r.prototype.getTransformedShape=function(e){return e&&this._segment?new r({start:e.transformPoint(this._segment.start),end:e.transformPoint(this._segment.end)}):this._segment?new r(this._segment):null},r.prototype._checkDirty=function(){if(this._segment&&this._dirty){this._dirty=!1;var e=this._segment.start.x,t=this._segment.start.y,n=this._segment.end.x,r=this._segment.end.y;if(n<e){var o=e;e=n,n=o}if(r<t){o=t;t=r,r=o}this._boundingbox={x:e,y:t,w:n-e+1,h:r-t+1}}},r.type="Segment",r}(i.BoundingShape);t.BoundingSegment=n});t(_);_.BoundingSegment;var b=n(function(e,t){var r,o=Q&&Q.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var n=function(n){function s(e){var t=n.call(this,s.type)||this;return t._sphere=e||null,t._dirty=!!t._sphere,t._boundingbox=null,t}return o(s,n),Object.defineProperty(s.prototype,"center",{get:function(){return this._sphere?this._sphere.center:null},set:function(e){e&&(this._sphere?this._sphere.center=e:this._sphere={center:e,radius:1},this._dirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"radius",{get:function(){return this._sphere?this._sphere.radius:null},set:function(e){null!==e&&(this._sphere?this._sphere.radius=e:this._sphere={center:{x:0,y:0},radius:e},this._dirty=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"sphere",{get:function(){return this._sphere?{center:this._sphere.center,radius:this._sphere.radius}:null},set:function(e){this._sphere=e,this._dirty=!!e,this._boundingbox=null},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"boundingbox",{get:function(){return this._checkDirty(),this._boundingbox},enumerable:!0,configurable:!0}),s.prototype.getBoundingbox=function(){return this.boundingbox},s.prototype.getTransformedShape=function(e){if(e&&this._sphere){for(var t=.125*Math.PI,n=2*t,r=this._sphere.radius/Math.cos(t),o=new g.BoundingHull,i=t;i<2*Math.PI;i+=n){var a=e.transformPoint({x:r*Math.cos(i),y:r*Math.sin(i)});a.x=Math.round(a.x),a.y=Math.round(a.y),o.addPoint(a)}return o}return this._sphere?new s(this._sphere):null},s.prototype._checkDirty=function(){this._sphere&&this._dirty&&(this._dirty=!1,this._boundingbox={x:this._sphere.center.x-this._sphere.radius+1,y:this._sphere.center.y-this._sphere.radius+1,w:2*this._sphere.radius-1,h:2*this._sphere.radius-1})},s.type="sphere",s}(i.BoundingShape);t.BoundingSphere=n});t(b);b.BoundingSphere;var J=n(function(e,t){function n(e,t){return!!e&&!!t&&e.x<=t.x+t.w&&e.x+e.w>=t.x&&e.y<=t.y+t.h&&e.y+e.h>=t.y}function r(e,t){return!!e&&!!t&&t.x>=e.x&&t.x<=e.x+e.w&&t.y>=e.y&&t.y<=e.y+e.h}function o(e,t){return!!e&&!!t&&h([v.GetTopLeft(e),v.GetBottomLeft(e),v.GetBottomRight(e),v.GetTopRight(e)],t)}function i(e,t){return e&&t?p([v.GetTopLeft(e),v.GetBottomLeft(e),v.GetBottomRight(e),v.GetTopRight(e)],t):null}function a(e,t){if(!e||!t)return!1;var n=v.ClampPoint(t.center,{x:e.x,y:e.y},{x:e.x+e.w-1,y:e.y+e.h-1}),r=v.GetVector(n,t.center);return v.DotProduct(r,r)<t.radius*t.radius}function s(e,t){if(!e||!t)return!1;for(var n=e.radius*e.radius,r=0;r<t.length;r++){var o=e.center.x-t[r].x,i=e.center.y-t[r].y;if(o*o+i*i<n)return!0}for(r=0;r<t.length;r++){var a=u(e,{start:t[r],end:t[(r+1)%t.length]});if(null!==a&&0<a.length)return!0}return c(t,e.center)}function c(e,t){for(var n=0;n<e.length;n++){var r=v.GetVector(t,e[n]),o=v.GetVector(t,e[(n+1)%e.length]);if(0<v.CrossProduct(r,o))return!1}return!0}function l(e,t){if(!e||!t)return!1;var n=e.center.x-t.center.x,r=e.center.y-t.center.y,o=e.radius+t.radius;return n*n+r*r<o*o}function u(e,t){if(!e||!t)return null;var n=v.GetVector(t.start,t.end),r=v.GetVector(e.center,t.start),o=v.DotProduct(n,n),i=2*v.DotProduct(r,n),a=i*i-4*o*(v.DotProduct(r,r)-e.radius*e.radius);if(a<0)return null;var s=(-i-(a=Math.sqrt(a)))/(2*o),c=(-i+a)/(2*o);if(c<s){var l=s;s=c,c=l}var u=[];return 0<=s&&s<=1&&u.push({x:t.start.x+s*n.x,y:t.start.y+s*n.y}),0<=c&&c<=1&&u.push({x:t.start.x+c*n.x,y:t.start.y+c*n.y}),u}function p(e,n){if(!e||!n)return null;if(c(e,n.start)&&c(e,n.end))return[];for(var t=[],r=0;r<e.length;r++){var o=y({start:e[r],end:e[(r+1)%e.length]},n);o&&t.push(o)}return 1<t.length&&t.sort(function(e,t){return v.DistanceSq(e,n.start)-v.DistanceSq(t,n.start)}),0<t.length?t:null}function h(e,t){for(var l=[e,t],n=0;n<2;n++)for(var u=l[n],r=function(e){var t=u[(e+1)%u.length].x-u[e].x,n=u[(e+1)%u.length].y-u[e].y,r=Math.sqrt(t*t+n*n);if(r<1)return"continue";for(var o=-n/r,i=t/r,a=[{min:9999999,max:-9999999},{min:9999999,max:-9999999}],s=function(n){l[n].forEach(function(e){var t=e.x*o+e.y*i;t<a[n].min&&(a[n].min=t),t>a[n].max&&(a[n].max=t)})},c=0;c<2;c++)s(c);return a[0].min>a[1].max||a[0].max<a[1].min?{value:!1}:void 0},o=0;o<u.length;o++){var i=r(o);if("object"==typeof i)return i.value}return!0}function f(e,t){if(!e||!t)return!1;var n=e.center.x-t.x,r=e.center.y-t.y;return n*n+r*r<e.radius*e.radius}function d(e,t){if(!e||!t)return!1;var n=e.start.x,r=e.start.y,o=e.end.x,i=e.end.y;if(o<n){var a=n;n=o,o=a}if(i<r){a=r;r=i,i=a}if(t.x<n||t.x>o||t.y<r||t.y>i)return!1;if(o!==n){var s=Math.round(r+(i-r)*(t.x-n)/(o-n))-t.y;return-1<=s&&s<=1}if(i===r)return t.x===n&&t.y===r;var c=Math.round(n+(o-n)*(t.y-r)/(i-r))-t.x;return-1<=c&&c<=1}function y(e,t){function n(e,t){return 0<=e&&0<=t||e<=0&&t<=0}if(!e||!t)return null;var r,o,i,a,s,c=e.start.x,l=e.start.y,u=e.end.x,p=e.end.y,h=t.start.x,f=t.start.y,d=t.end.x,y=t.end.y,v=u-c,g=h-d;if(v<0?(r=u,o=c):(o=u,r=c),0<g){if(o<d||h<r)return null}else if(o<h||d<r)return null;var m=p-l,_=f-y;if(m<0?(i=p,a=l):(a=p,i=l),0<_){if(a<y||f<i)return null}else if(a<f||y<i)return null;var b=c-h,w=l-f,P=m*g-v*_;if(0===P)return null;var x=_*b-g*w;if(0<P){if(x<0||P<x)return null}else if(0<x||x<P)return null;var T=v*w-m*b;if(0<P){if(T<0||P<T)return null}else if(0<T||T<P)return null;return{x:c+(((s=x*v)+(n(s,P)?P/2:-P/2))/P>>0),y:l+(((s=x*m)+(n(s,P)?P/2:-P/2))/P>>0)}}Object.defineProperty(t,"__esModule",{value:!0}),t.IntersectionTestShapeSegment=function(e,t){if(!e||!t)return null;if(e.getBoundingbox())switch(e.type){case m.BoundingBox.type:return i(e.rect,t);case g.BoundingHull.type:return p(e.points,t);case _.BoundingSegment.type:var n=y(e.segment,t);return n?[n]:[];case b.BoundingSphere.type:return u(e.sphere,t)}return null},t.IntersectionTestShapeBox=function(e,t){if(!e.getBoundingbox())return!1;switch(e.type){case m.BoundingBox.type:return n(e.rect,t);case g.BoundingHull.type:return o(t,e.points);case _.BoundingSegment.type:return null!=i(t,e.segment);case b.BoundingSphere.type:return a(t,e.sphere);default:return!1}},t.IntersectionTestShapeHull=function(e,t){if(!e.getBoundingbox())return!1;switch(e.type){case m.BoundingBox.type:return o(e.rect,t);case g.BoundingHull.type:return h(e.points,t);case _.BoundingSegment.type:return null!=p(t,e.segment);case b.BoundingSphere.type:return s(e.sphere,t);default:return!1}},t.IntersectionTestShapePoint=function(e,t){if(!r(e.getBoundingbox(),t))return!1;switch(e.type){case m.BoundingBox.type:return!0;case g.BoundingHull.type:return c(e.points,t);case _.BoundingSegment.type:return d(e.segment,t);case b.BoundingSphere.type:return f(e.sphere,t);default:return!1}},t.IntersectionTestShapeShape=function(e,t){if(!n(e.getBoundingbox(),t.getBoundingbox()))return!1;switch(e.type){case m.BoundingBox.type:switch(t.type){case m.BoundingBox.type:return!0;case g.BoundingHull.type:return o(e.rect,t.points);case _.BoundingSegment.type:return null!=i(e.rect,t.segment);case b.BoundingSphere.type:return a(e.rect,t.sphere);default:return!1}case g.BoundingHull.type:switch(t.type){case m.BoundingBox.type:return o(t.rect,e.points);case g.BoundingHull.type:return h(e.points,t.points);case _.BoundingSegment.type:return null!=p(e.points,t.segment);case b.BoundingSphere.type:return s(t.sphere,e.points);default:return!1}case _.BoundingSegment.type:switch(t.type){case m.BoundingBox.type:return null!=i(t.rect,e.segment);case g.BoundingHull.type:return null!=p(t.points,e.segment);case _.BoundingSegment.type:return null!=y(t.segment,e.segment);case b.BoundingSphere.type:return null!=u(t.sphere,e.segment);default:return!1}case b.BoundingSphere.type:switch(t.type){case m.BoundingBox.type:return a(t.rect,e.sphere);case g.BoundingHull.type:return s(e.sphere,t.points);case _.BoundingSegment.type:return null!=u(e.sphere,t.segment);case b.BoundingSphere.type:return l(e.sphere,t.sphere);default:return!1}default:return!1}},t.IntersectionTestBoxBox=n,t.IntersectionTestBoxPoint=r,t.IntersectionTestBoxHull=o,t.IntersectionTestBoxSegment=i,t.IntersectionTestBoxSphere=a,t.IntersectionTestSphereHull=s,t.IntersectionTestHullPoint=c,t.IntersectionTestSphereSphere=l,t.IntersectionTestSphereSegment=u,t.IntersectionTestHullSegment=p,t.IntersectionTestHullHull=h,t.IntersectionTestSpherePoint=f,t.IntersectionTestSegmentPoint=d,t.IntersectionTestSegmentSegment=y});t(J);J.IntersectionTestShapeSegment,J.IntersectionTestShapeBox,J.IntersectionTestShapeHull,J.IntersectionTestShapePoint,J.IntersectionTestShapeShape,J.IntersectionTestBoxBox,J.IntersectionTestBoxPoint,J.IntersectionTestBoxHull,J.IntersectionTestBoxSegment,J.IntersectionTestBoxSphere,J.IntersectionTestSphereHull,J.IntersectionTestHullPoint,J.IntersectionTestSphereSphere,J.IntersectionTestSphereSegment,J.IntersectionTestHullSegment,J.IntersectionTestHullHull,J.IntersectionTestSpherePoint,J.IntersectionTestSegmentPoint,J.IntersectionTestSegmentSegment;var l=n(function(e,t){var r,c,n,o=Q&&Q.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0}),(n=c=t.SplineType||(t.SplineType={}))[n.STEP=1]="STEP",n[n.LINEAR=2]="LINEAR",n[n.POLY=3]="POLY";var i=function(){function e(e,t){void 0===t&&(t=!1),this.cp=e,this.clamp=t}return e.prototype.eval=function(e){return 0},e.prototype.evalFirst=function(){return 0<this.cp.length?this.cp[0].y:0},e.prototype.evalLast=function(){return 0<this.cp.length?this.cp[this.cp.length-1].y:0},e}(),l=function(r){function e(e,t){void 0===t&&(t=!1);var n=r.call(this,e,t)||this;return n.h=new Array(e.length-1),n.compute(),n}return o(e,r),e.prototype.compute=function(){for(var e=0;e<this.cp.length-1;++e)this.h[e]=this.cp[e+1].x-this.cp[e].x},e.prototype.getSegment=function(e){var t;for(t=0;t<this.cp.length-1&&!(e<this.cp[t+1].x);t++);return t},e.prototype.eval=function(e){if(this.clamp){if(e<0)return this.cp[0].y;if(e>this.cp[this.cp.length-1].x)return this.cp[this.cp.length-1].y}var t=this.getSegment(e);return this.cp[t].y},e}(t.CurveEvaluter=i);t.StepEvaluter=l;var u=function(r){function e(e,t){void 0===t&&(t=!1);var n=r.call(this,e,t)||this;return n.h=new Array(e.length-1),n.cp=e,n.compute(),n}return o(e,r),e.prototype.compute=function(){for(var e=0;e<this.cp.length-1;++e)this.h[e]=this.cp[e+1].x-this.cp[e].x},e.prototype.getSegment=function(e){var t;for(t=0;t<this.cp.length-1&&!(e<this.cp[t+1].x);t++);return t===this.cp.length-1&&t--,t},e.prototype.eval=function(e){if(this.clamp){if(e<0)return this.cp[0].y;if(e>this.cp[this.cp.length-1].x)return this.cp[this.cp.length-1].y}var t=this.getSegment(e),n=e-this.cp[t].x;return this.cp[t].y+(this.cp[t+1].y-this.cp[t].y)*n/this.h[t]},e}(i);t.CoLinearEvaluter=u;var p=function(r){function e(e,t){void 0===t&&(t=!1);var n=r.call(this,e,t)||this;return n.a=new Array(e.length),n.h=new Array(e.length),n.cp=e,n.compute(),n}return o(e,r),e.prototype.solveTridiag=function(e,t,n){for(var r=this.cp.length-2,o=2;o<=r;o++)e[o]/=t[o-1],t[o]-=e[o]*n[o-1],this.a[o]-=this.a[o-1]*e[o];this.a[r]/=t[r];for(o=r-1;1<=o;--o)this.a[o]=(this.a[o]-this.a[o+1]*n[o])/t[o]},e.prototype.compute=function(){var e=this.cp.length,t=new Array(e-1),n=new Array(e-1),r=new Array(e-1);this.a[0]=0,this.a[e-1]=0;for(var o=1;o<e;++o)this.h[o]=this.cp[o].x-this.cp[o-1].x;for(o=1;o<e-1;++o)n[o]=(this.h[o]+this.h[o+1])/3,r[o]=this.h[o+1]/6,t[o]=this.h[o]/6,this.a[o]=(this.cp[o+1].y-this.cp[o].y)/this.h[o+1]-(this.cp[o].y-this.cp[o-1].y)/this.h[o];this.solveTridiag(t,n,r)},e.prototype.getSegment=function(e){var t;for(t=0;t<this.cp.length-1&&!(e<this.cp[t+1].x);t++);return t===this.cp.length-1&&t--,t},e.prototype.eval=function(e){if(this.clamp){if(e<0)return this.cp[0].y;if(e>this.cp[this.cp.length-1].x)return this.cp[this.cp.length-1].y}var t=this.getSegment(e)+1,n=e-this.cp[t-1].x,r=this.h[t]-n;return((-this.a[t-1]/6*(r+this.h[t])*n+this.cp[t-1].y)*r+(-this.a[t]/6*(n+this.h[t])*r+this.cp[t].y)*n)/this.h[t]},e}(i);t.PolynomialsEvaluter=p;var a=function(){function e(e,t,n){void 0===n&&(n=!1),this._evalutors=[],this._array=!1,0<t.length&&("number"==typeof t[0].y?this.initNonArray(e,t,n):this.initArray(e,t,n))}return e.prototype.eval=function(t){if(0<this._evalutors.length){if(this._array){var n=[];return this._evalutors.forEach(function(e){n.push(e.eval(t))}),n}return this._evalutors[0].eval(t)}return 0},e.prototype.evalFirst=function(){if(0<this._evalutors.length){if(this._array){var t=[];return this._evalutors.forEach(function(e){t.push(e.evalFirst())}),t}return this._evalutors[0].evalFirst()}return 0},e.prototype.evalLast=function(){if(0<this._evalutors.length){if(this._array){var t=[];return this._evalutors.forEach(function(e){t.push(e.evalLast())}),t}return this._evalutors[0].evalLast()}return 0},e.prototype.initArray=function(e,t,n){var r=t[0].y.length;if(0<r){for(var o=0;o<r;o++){for(var i=[],a=0;a<t.length;a++){var s=t[a].y.length>o?t[a].y[o]:0;i.push({x:t[a].x,y:s})}switch(e){case c.STEP:this._evalutors.push(new l(i,n));break;case c.LINEAR:this._evalutors.push(new u(i,n));break;case c.POLY:default:this._evalutors.push(new p(i,n))}}this._array=!0}},e.prototype.initNonArray=function(e,t,n){switch(e){case c.STEP:this._evalutors.push(new l(t,n));break;case c.LINEAR:this._evalutors.push(new u(t,n));break;case c.POLY:default:this._evalutors.push(new p(t,n))}this._array=!1},e}();t.Spline=a});t(l);l.SplineType,l.CurveEvaluter,l.StepEvaluter,l.CoLinearEvaluter,l.PolynomialsEvaluter,l.Spline;var o=n(function(e,t){var n;Object.defineProperty(t,"__esModule",{value:!0}),(n=t.KeyCode||(t.KeyCode={}))[n.kBackspace=8]="kBackspace",n[n.kTab=9]="kTab",n[n.kClear=12]="kClear",n[n.kEnter=13]="kEnter",n[n.kShift=16]="kShift",n[n.kControl=17]="kControl",n[n.kAlt=18]="kAlt",n[n.kPause=19]="kPause",n[n.kCapsLock=20]="kCapsLock",n[n.kEscape=27]="kEscape",n[n.kSpace=32]="kSpace",n[n.kPageUp=33]="kPageUp",n[n.kPageDown=34]="kPageDown",n[n.kEnd=35]="kEnd",n[n.kHome=36]="kHome",n[n.kLeft=37]="kLeft",n[n.kUp=38]="kUp",n[n.kRight=39]="kRight",n[n.kDown=40]="kDown",n[n.kSelect=41]="kSelect",n[n.kPrint=42]="kPrint",n[n.kExecute=43]="kExecute",n[n.kInsert=45]="kInsert",n[n.kDelete=46]="kDelete",n[n.kHelp=47]="kHelp",n[n.k0=48]="k0",n[n.k1=49]="k1",n[n.k2=50]="k2",n[n.k3=51]="k3",n[n.k4=52]="k4",n[n.k5=53]="k5",n[n.k6=54]="k6",n[n.k7=55]="k7",n[n.k8=56]="k8",n[n.k9=57]="k9",n[n.kA=65]="kA",n[n.kB=66]="kB",n[n.kC=67]="kC",n[n.kD=68]="kD",n[n.kE=69]="kE",n[n.kF=70]="kF",n[n.kG=71]="kG",n[n.kH=72]="kH",n[n.kI=73]="kI",n[n.kJ=74]="kJ",n[n.kK=75]="kK",n[n.kL=76]="kL",n[n.kM=77]="kM",n[n.kN=78]="kN",n[n.kO=79]="kO",n[n.kP=80]="kP",n[n.kQ=81]="kQ",n[n.kR=82]="kR",n[n.kS=83]="kS",n[n.kT=84]="kT",n[n.kU=85]="kU",n[n.kV=86]="kV",n[n.kW=87]="kW",n[n.kX=88]="kX",n[n.kY=89]="kY",n[n.kZ=90]="kZ",n[n.kLeftMeta=91]="kLeftMeta",n[n.kRightMeta=92]="kRightMeta",n[n.kMenu=93]="kMenu",n[n.kKP0=96]="kKP0",n[n.kKP1=97]="kKP1",n[n.kKP2=98]="kKP2",n[n.kKP3=99]="kKP3",n[n.kKP4=100]="kKP4",n[n.kKP5=101]="kKP5",n[n.kKP6=102]="kKP6",n[n.kKP7=103]="kKP7",n[n.kKP8=104]="kKP8",n[n.kKP9=105]="kKP9",n[n.kKPMul=106]="kKPMul",n[n.kKPAdd=107]="kKPAdd",n[n.kKPSep=108]="kKPSep",n[n.kKPSub=109]="kKPSub",n[n.kKPDec=110]="kKPDec",n[n.kKPDiv=111]="kKPDiv",n[n.kF1=112]="kF1",n[n.kF2=113]="kF2",n[n.kF3=114]="kF3",n[n.kF4=115]="kF4",n[n.kF5=116]="kF5",n[n.kF6=117]="kF6",n[n.kF7=118]="kF7",n[n.kF8=119]="kF8",n[n.kF9=120]="kF9",n[n.kF10=121]="kF10",n[n.kF11=122]="kF11",n[n.kF12=123]="kF12",n[n.kNumLock=144]="kNumLock",n[n.kScrollLock=145]="kScrollLock",n[n.kAdd=187]="kAdd",n[n.kComma=188]="kComma",n[n.kMinus=189]="kMinus",n[n.kPeriod=190]="kPeriod",n[n.kApostrophe=192]="kApostrophe",n[n.kLeftBrace=219]="kLeftBrace",n[n.kRightBrace=221]="kRightBrace",n[n.kBackSlash=220]="kBackSlash",n[n.kQuot=222]="kQuot",n[n.kSemicolon=186]="kSemicolon",n[n.kSlash=191]="kSlash"});t(o);o.KeyCode;var Z=n(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function r(){this.a=1,this.b=0,this.c=0,this.d=1,this.e=0,this.f=0}return r.getIdentity=function(){return new r},r.getTranslate=function(e,t){return(new r).makeTranslate(e,t)},r.getScale=function(e,t){return(new r).makeScale(e,t)},r.getRotate=function(e){return(new r).makeRotate(e)},r.transform=function(e,t){return(new r).copyFrom(e).transform(t)},r.translate=function(e,t,n){return(new r).copyFrom(e).translate(t,n)},r.scale=function(e,t,n){return(new r).copyFrom(e).scale(t,n)},r.rotate=function(e,t){return(new r).copyFrom(e).rotate(t)},r.invert=function(e){return(new r).copyFrom(e).invert()},r.prototype.set=function(e,t,n,r,o,i){return this.a=e,this.b=t,this.c=n,this.d=r,this.e=o,this.f=i,this},r.prototype.makeIdentity=function(){return this.set(1,0,0,1,0,0)},r.prototype.makeTranslate=function(e,t){return this.set(1,0,0,1,e,t)},r.prototype.makeScale=function(e,t){return this.set(e,0,0,t,0,0)},r.prototype.makeRotate=function(e){var t=Math.sin(e),n=Math.cos(e);return this.set(n,t,-t,n,0,0)},r.prototype.copyFrom=function(e){return this.set(e.a,e.b,e.c,e.d,e.e,e.f)},r.prototype.transform=function(e){return this.set(this.a*e.a+this.c*e.b,this.b*e.a+this.d*e.b,this.a*e.c+this.c*e.d,this.b*e.c+this.d*e.d,this.a*e.e+this.c*e.f+this.e,this.b*e.e+this.d*e.f+this.f)},r.prototype.transformPoint=function(e){return{x:Math.round(this.a*e.x+this.c*e.y+this.e),y:Math.round(this.b*e.x+this.d*e.y+this.f)}},r.prototype.translate=function(e,t){return this.transform(r.getTranslate(e,t))},r.prototype.scale=function(e,t){return this.transform(r.getScale(e,t))},r.prototype.rotate=function(e){return this.transform(r.getRotate(e))},r.prototype.invert=function(){var e=this.a,t=this.b,n=this.c,r=this.d,o=this.e,i=this.f,a=1*r-0*i,s=-1*n+0*o,c=i*n-r*o,l=e*a+t*s+0*c;return l&&(l=1/l,this.a=a*l,this.b=(-1*t+0*i)*l,this.c=s*l,this.d=(1*e-0*o)*l,this.e=c*l,this.f=(-i*e+t*o)*l),this},r.prototype.getTranslationPart=function(){return{x:this.e,y:this.f}},r.prototype.setTranslationPart=function(e){this.e=e.x,this.f=e.y},r.prototype.getScalePart=function(){return{x:Math.sqrt(this.a*this.a+this.b*this.b),y:Math.sqrt(this.c*this.c+this.d*this.d)}},r.prototype.setScalePart=function(e){var t=this.getScalePart(),n=e.x/t.x;this.a*=n,this.b*=n;var r=e.y/t.y;this.c*=r,this.d*=r},r.prototype.getRotationPart=function(){var e=Math.sqrt(this.a*this.a+this.b*this.b);if(0===e)return 0;var t=Math.max(Math.min(this.a/e,1),-1),n=Math.max(Math.min(this.b/e,1),-1),r=Math.acos(t);return 0<=n?r:2*Math.PI-r},r.prototype.setRotationPart=function(e){var t=this.getScalePart(),n=Math.sin(e),r=Math.cos(e);this.a=t.x*r,this.b=t.x*n,this.c=-t.y*n,this.d=t.y*r},r}();t.Matrix2d=n});t(Z);Z.Matrix2d;var u=n(function(e,t){var r,s,n,h=Q&&Q.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0}),(n=s=t.EventListenerOrder||(t.EventListenerOrder={}))[n.FIRST=1]="FIRST",n[n.LAST=2]="LAST";var o=function(){function e(e){this.type=e,this.eaten=!1}return e.prototype.eat=function(){this.eaten=!0},e}(),i=function(n){function r(e){var t=n.call(this,r.type)||this;return t.object=e,t.allow=!0,t}return h(r,n),r.type="@componentBeforeAttach",r}(t.BaseEvent=o);t.EvtComponentBeforeAttach=i;var a=function(e){function t(){return e.call(this,t.type)||this}return h(t,e),t.type="@componentAttached",t}(o);t.EvtComponentAttached=a;var c=function(t){function n(){var e=t.call(this,n.type)||this;return e.allow=!0,e}return h(n,t),n.type="@componentBeforeDetach",n}(o);t.EvtComponentBeforeDetach=c;var l=function(e){function t(){return e.call(this,t.type)||this}return h(t,e),t.type="@componentDetached",t}(o);t.EvtComponentDetached=l;var u=function(o){function i(e,t,n){var r=o.call(this,i.type)||this;return r.deltaTime=e,r.elapsedTime=t,r.frameStamp=n,r}return h(i,o),i.type="@update",i}(o);t.EvtUpdate=u;var p=function(r){function o(e,t){var n=r.call(this,o.type)||this;return n.canvasWidth=e,n.canvasHeight=t,n.result={},n}return h(o,r),o.prototype.addObject=function(e,t,n){var r=this.result[t]||[];r.push({object:e,z:t,transform:n}),this.result[t]=r},o.type="@cull",o}(o);t.EvtCull=p;var f=function(o){function i(e,t,n){var r=o.call(this,i.type)||this;return r.canvas=e,r.z=t,r.transform=n,r}return h(i,o),i.type="@draw",i}(o);t.EvtDraw=f;var d=function(r){function o(e,t){var n=r.call(this,o.type)||this;return n.x=e,n.y=t,n.result=!1,n}return h(o,r),o.type="@hittest",o}(o);t.EvtHitTest=d;var y=function(e){function t(){return e.call(this,t.type)||this}return h(t,e),t.type="@getboundingshape",t}(o);t.EvtGetBoundingShape=y;var v=function(o){function i(e,t,n){var r=o.call(this,i.type)||this;return r.deltaTime=e,r.elapsedTime=t,r.frameStamp=n,r}return h(i,o),i.type="@frame",i}(o);t.EvtFrame=v;var g=function(n){function r(e){var t=n.call(this,r.type)||this;return t.focus=e,t}return h(r,n),r.type="@focus",r}(o);t.EvtFocus=g;var m=function(c){function e(e,t,n,r,o,i,a){var s=c.call(this,e)||this;return s.key=t,s.keyCode=n,s.shiftDown=r,s.altDown=o,s.ctrlDown=i,s.metaDown=a,s}return h(e,c),e}(o),_=function(a){function s(e,t,n,r,o,i){return a.call(this,s.type,e,t,n,r,o,i)||this}return h(s,a),s.type="@keydown",s}(t.EvtKeyboard=m);t.EvtKeyDown=_;var b=function(a){function s(e,t,n,r,o,i){return a.call(this,s.type,e,t,n,r,o,i)||this}return h(s,a),s.type="@keyup",s}(m);t.EvtKeyUp=b;var w=function(a){function s(e,t,n,r,o,i){return a.call(this,s.type,e,t,n,r,o,i)||this}return h(s,a),s.type="@keypress",s}(m);t.EvtKeyPress=w;var P=function(l){function e(e,t,n,r,o,i,a,s){var c=l.call(this,e)||this;return c.x=t,c.y=n,c.button=r,c.shiftDown=o,c.altDown=i,c.ctrlDown=a,c.metaDown=s,c.bubble=!0,c}return h(e,l),e.prototype.cancelBubble=function(){this.bubble=!1},e}(o),x=function(s){function c(e,t,n,r,o,i,a){return s.call(this,c.type,e,t,n,r,o,i,a)||this}return h(c,s),c.type="@mousedown",c}(t.EvtMouse=P);t.EvtMouseDown=x;var T=function(s){function c(e,t,n,r,o,i,a){return s.call(this,c.type,e,t,n,r,o,i,a)||this}return h(c,s),c.type="@mouseup",c}(P);t.EvtMouseUp=T;var j=function(s){function c(e,t,n,r,o,i,a){return s.call(this,c.type,e,t,n,r,o,i,a)||this}return h(c,s),c.type="@mousemove",c}(P);t.EvtMouseMove=j;var k=function(e){function t(){return e.call(this,t.type)||this}return h(t,e),t.type="@mouseenter",t}(o);t.EvtMouseEnter=k;var S=function(e){function t(){return e.call(this,t.type)||this}return h(t,e),t.type="@mouseleave",t}(o);t.EvtMouseLeave=S;var E=function(s){function c(e,t,n,r,o,i,a){return s.call(this,c.type,e,t,n,r,o,i,a)||this}return h(c,s),c.type="@click",c}(P);t.EvtClick=E;var O=function(s){function c(e,t,n,r,o,i,a){return s.call(this,c.type,e,t,n,r,o,i,a)||this}return h(c,s),c.type="@dblclick",c}(P);t.EvtDblClick=O;var C=function(c){function l(e,t,n,r,o,i,a){var s=c.call(this,l.type,e,t,n,r,o,i,a)||this;return s.data=null,s}return h(l,c),l.type="@dragbegin",l}(P);t.EvtDragBegin=C;var B=function(l){function u(e,t,n,r,o,i,a,s){var c=l.call(this,u.type,e,t,n,r,o,i,a)||this;return c.data=s,c}return h(u,l),u.type="@dragend",u}(P);t.EvtDragEnd=B;var W=function(l){function u(e,t,n,r,o,i,a,s){var c=l.call(this,u.type,e,t,n,r,o,i,a)||this;return c.data=s,c}return h(u,l),u.type="@dragging",u}(P);t.EvtDragging=W;var M=function(u){function p(e,t,n,r,o,i,a,s,c){var l=u.call(this,p.type,e,t,n,r,o,i,a)||this;return l.object=s,l.data=c,l}return h(p,u),p.type="@dragover",p}(P);t.EvtDragOver=M;var A=function(u){function p(e,t,n,r,o,i,a,s,c){var l=u.call(this,p.type,e,t,n,r,o,i,a)||this;return l.object=s,l.data=c,l}return h(p,u),p.type="@dragdrop",p}(P);t.EvtDragDrop=A;var D=function(e){function t(){return e.call(this,t.type)||this}return h(t,e),t.type="@resize",t}(o);t.EvtResize=D;var F=function(n){function r(e){var t=n.call(this,r.type)||this;return t.view=e,t}return h(r,n),r.type="@canvasresize",r}(o);t.EvtCanvasResize=F;var I=function(n){function r(e){var t=n.call(this,r.type)||this;return t.propName=e,t.propValue=void 0,t}return h(r,n),r.type="@getprop",r}(o);t.EvtGetProp=I;var L=function(r){function o(e,t){var n=r.call(this,o.type)||this;return n.propName=e,n.propValue=t,n}return h(o,r),o.type="@setprop",o}(o);t.EvtSetProp=L;var N=function(o){function i(e,t,n){var r=o.call(this,i.type)||this;return r.view=e,r.oldPage=t,r.newPage=n,r}return h(i,o),i.type="@scenviewpagewillchange",i}(o);t.EvtSceneViewPageWillChange=N;var z=function(o){function i(e,t,n){var r=o.call(this,i.type)||this;return r.view=e,r.oldPage=t,r.newPage=n,r}return h(i,o),i.type="@sceneviewpagechanged",i}(o);t.EvtSceneViewPageChanged=z;var R=function(){function e(){}return e.isWindows=function(){return this._isWindows},e.isMac=function(){return this._isMac},e.isUnix=function(){return this._isX11&&!this._isWindows&&!this._isMac},e.isLinux=function(){return this._isLinux},e.isAndroid=function(){return this._isLinux&&this._isAndroid},e._isWindows="Win32"===navigator.platform||"Windows"===navigator.platform,e._isMac="Mac68K"===navigator.platform||"MacPPC"===navigator.platform||"Macintosh"===navigator.platform||"MacIntel"===navigator.platform,e._isX11="X11"===navigator.platform,e._isLinux=0<=String(navigator.platform).indexOf("Linux"),e._isAndroid=0<=(navigator.userAgent.toLowerCase().match(/android/i)||[]).indexOf("android"),e}();t.EvtSysInfo=R;var V=function(){function e(){}return e.prototype.on=function(e,t,n){K.addEventListener(e,this,t,n||s.FIRST)},e.prototype.off=function(e,t){K.removeEventListener(e,this,t)},e.prototype.trigger=function(e){K.triggerEvent(this,e)},e.prototype.triggerEx=function(e){this.trigger(e)},e.prototype.post=function(e){K.postEvent(this,e)},e}();t.EventObserver=V;var K=function(){function n(){}return n.postEvent=function(e,t){this.eventQueue.push({evt:t,target:e})},n.triggerEvent=function(e,t){this.processEvent(t,e)},n.processPendingEvents=function(){var t=this,e=this.eventQueue;this.eventQueue=[],e.forEach(function(e){t.processEvent(e.evt,e.target)})},n.addEventListener=function(e,t,n,r){for(var o=this.eventListeners[e]||[],i=0;i<o.length;i++)if(o[i].bindObject===t){if(r===s.FIRST)o[i].handlers={handler:n,next:o[i].handlers};else{var a=o[i].handlers;if(a){for(;a.next;)a=a.next;a.next={handler:n,next:null}}}return}o.push({bindObject:t,handlers:{handler:n,next:null}}),this.eventListeners[e]=o},n.removeEventListener=function(e,t,n){for(var r=this.eventListeners[e]||[],o=0;o<r.length;o++)if(r[o].bindObject===t){if(!n){r.splice(o,1);break}for(var i=r[o].handlers,a=null;i&&i.handler!==n;)i=(a=i).next;i&&(a?a.next=i.next:r[o].handlers=i.next),r[o].handlers||r.splice(o,1)}},n.run=function(){this.running||(this.running=!0,this.lastFrameTime=0,this.firstFrameTime=0,this.elapsedTime=0,this.deltaTime=0,this.frameStamp=0,this.init(),requestAnimationFrame(function e(t){n.running&&(0===n.lastFrameTime&&(n.lastFrameTime=t,n.firstFrameTime=t),n.deltaTime=t-n.lastFrameTime,n.elapsedTime=t-n.firstFrameTime,n.lastFrameTime=t,n.frameStamp++,n.processPendingEvents(),n.triggerEvent(null,new v(n.deltaTime,n.elapsedTime,n.frameStamp)),n.running&&requestAnimationFrame(e))}))},n.addView=function(e){return!(!e||!e.canvas||this.findView(e.canvas.canvas))&&(this.views.push(e),this.focusView||this.setFocusView(e),!0)},n.addCanvas=function(e,t){if(this.findView(e))return null;var n=new X(e,void 0!==t&&t);return this.addView(n)?n:null},n.setFocusView=function(e){this.focusView!==e&&(this.focusView&&this.focusView.trigger(new g(!1)),this.focusView=e,this.focusView&&this.focusView.trigger(new g(!0)))},n.findView=function(e){for(var t=0;t<this.views.length;t++)if(this.views[t].canvas.canvas===e)return this.views[t];return null},n.removeView=function(e){for(var t=0;t<this.views.length;t++)this.views[t].canvas.canvas===e&&this.views.splice(t,1)},n.setCapture=function(e){this.capturedView=e},n.init=function(){this.initEventListeners()},n.processEvent=function(e,t){var n=this.eventListeners[e.type];if(n)for(var r=0;r<n.length;r++){var o=n[r];if(!t||o.bindObject===t){for(var i=o.handlers;i&&(i.handler.call(o.bindObject,e),!e.eaten);)i=i.next;if(t)break}}},n.hitView=function(e,t){if(null!==this.capturedView)return this.capturedView;for(var n=0;n<this.views.length;n++){var r=this.views[n],o=r.canvas.viewport_rect;if(e>=o.x&&e<o.x+o.w&&t>=o.y&&t<o.y+o.h)return r}return null},n.resizeHandler=function(){var t=new D;this.views.forEach(function(e){e.triggerEx(t)})},n.mouseDownHandler=function(e){this.clickTick=Date.now();var t=this.hitView(e.clientX,e.clientY);null!==t&&t.handleMouseDown(e)},n.mouseUpHandler=function(e){var t=this.hitView(e.clientX,e.clientY);if(null!==t){var n=Date.now();n<this.clickTick+this.clickTime?n<this.dblClickTick+this.dblclickTime?(t.handleDblClick(e),this.dblClickTick=0):(t.handleClick(e),this.dblClickTick=n):this.dblClickTick=0,t.handleMouseUp(e),this.clickTick=0}else this.clickTick=0,this.dblClickTick=0},n.mouseMoveHandler=function(e){var t=this.hitView(e.clientX,e.clientY);if(t!==this.hoverView&&(this.hoverView&&(this.hoverView.triggerEx(new S),this.hoverView=null),null!==t&&(this.hoverView=t).triggerEx(new k)),null!==t){var n=t.canvas.viewport_rect;t.updateHitObjects(e.clientX-n.x,e.clientY-n.y),t.handleMouseMove(e)}},n.keyDownHandler=function(e){this.focusView&&this.focusView.trigger(new _(e.key,e.keyCode,e.shiftKey,e.altKey,e.ctrlKey,e.metaKey))},n.keyUpHandler=function(e){this.focusView&&this.focusView.trigger(new b(e.key,e.keyCode,e.shiftKey,e.altKey,e.ctrlKey,e.metaKey))},n.keyPressHandler=function(e){this.focusView&&this.focusView.trigger(new w(e.key,e.keyCode,e.shiftKey,e.altKey,e.ctrlKey,e.metaKey))},n.initEventListeners=function(){window.addEventListener("resize",this.resizeHandler.bind(this)),window.addEventListener(window.onpointerdown?"pointerdown":"mousedown",this.mouseDownHandler.bind(this)),window.addEventListener(window.onpointerup?"pointerup":"mouseup",this.mouseUpHandler.bind(this)),window.addEventListener(window.onpointermove?"pointermove":"mousemove",this.mouseMoveHandler.bind(this)),window.addEventListener("keydown",this.keyDownHandler.bind(this)),window.addEventListener("keyup",this.keyUpHandler.bind(this)),window.addEventListener("keypress",this.keyPressHandler.bind(this))},n.elapsedTime=0,n.deltaTime=0,n.eventQueue=[],n.eventListeners={},n.running=!1,n.lastFrameTime=0,n.firstFrameTime=0,n.frameStamp=0,n.capturedView=null,n.hoverView=null,n.focusView=null,n.views=[],n.clickTick=0,n.dblClickTick=0,n.clickTime=400,n.dblclickTime=400,n}();t.App=K;var G=function(n){function e(e){var t=n.call(this)||this;return t.type=e,t.object=null,t}return h(e,n),e.prototype.toString=function(){return"<Component: "+this.type+">"},e}(V);t.Component=G;var H=function(n){function e(){var e=n.call(this)||this;return e.components={},e}return h(e,n),e.prototype.toString=function(){return"<BaseObject>"},e.prototype.addComponent=function(e){if(null===e.object){var t=this.components[e.type]||[];if(t.indexOf(e)<0){var n=new i(this);e.trigger(n),n.object=null,n.allow&&(t.push(e),e.object=this,e.trigger(new a))}this.components[e.type]=t}return this},e.prototype.removeComponent=function(e){if(e.object===this){var t=this.components[e.type].indexOf(e);this.removeComponentByIndex(e.type,t)}return this},e.prototype.removeComponentByIndex=function(e,t){var n=this.components[e];if(n&&0<=t&&t<n.length){var r=new c;n[t].trigger(r),r.allow&&(n[t].trigger(new l),n[t].object=null,n.splice(t,1))}return this},e.prototype.removeComponentsByType=function(e){for(var t=this.components[e];t&&0<t.length;)this.removeComponentByIndex(e,t.length-1);return this},e.prototype.removeAllComponents=function(){var t=this;return Object.keys(this.components).forEach(function(e){t.removeComponentsByType(e)}),this},e.prototype.getComponent=function(e,t){void 0===t&&(t=0);var n=this.components[e];return void 0===n||t<0||n.length<=t?null:n[t]},e.prototype.getComponents=function(e){return this.components[e]},e.prototype.triggerEx=function(t){for(var e in n.prototype.trigger.call(this,t),this.components)this.components.hasOwnProperty(e)&&this.components[e].forEach(function(e){e.trigger(t)})},e.prototype.post=function(e){K.postEvent(this,e)},e}(V),Y=function(t){function e(e){var r=t.call(this)||this;return r._view=null,r._parent=null,r._z=0,r._visible=!0,r._children=[],r._localTransform=new Z.Matrix2d,r._worldTranslation=null,r._worldRotation=null,r._worldScale=null,r._anchorPoint={x:0,y:0},e&&e.addChild(r),r.on(p.type,function(e){e.addObject(r,r.z,r.worldTransform)}),r.on(d.type,function(e){var t=r.boundingShape;e.result=!!t&&J.IntersectionTestShapePoint(t,{x:e.x,y:e.y})}),r.on(I.type,function(e){switch(e.propName){case"z":e.propValue=r.z,e.eat();break;case"visible":e.propValue=r.visible,e.eat();break;case"transform":e.propValue=r.localTransform,e.eat();break;case"translation":var t=r.translation;e.propValue=[t.x,t.y],e.eat();break;case"scale":var n=r.scale;e.propValue=[n.x,n.y],e.eat();break;case"rotation":e.propValue=r.rotation,e.eat();break;case"anchorPoint":e.propValue=r.anchorPoint,e.eat()}}),r.on(L.type,function(e){switch(e.propName){case"z":r.z=e.propValue,e.eat();break;case"visible":r.visible=e.propValue,e.eat();break;case"transform":r.localTransform=e.propValue,e.eat();break;case"translation":var t=e.propValue;r.translation={x:Math.round(t[0]),y:Math.round(t[1])};break;case"scale":var n=e.propValue;r.scale={x:n[0],y:n[1]};break;case"rotation":r.rotation=e.propValue;break;case"anchorPoint":r.anchorPoint=e.propValue}}),r}return h(e,t),Object.defineProperty(e.prototype,"boundingShape",{get:function(){var e=new y;return this.triggerEx(e),e.shape||null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"view",{get:function(){return this._view},set:function(e){this._view=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"z",{get:function(){return this._z},set:function(e){this.setZ(e)},enumerable:!0,configurable:!0}),e.prototype.setZ=function(e){this._z=e},Object.defineProperty(e.prototype,"visible",{get:function(){return this._visible},set:function(e){this.setVisible(e)},enumerable:!0,configurable:!0}),e.prototype.setVisible=function(e){this._visible=e},Object.defineProperty(e.prototype,"localTransform",{get:function(){return this._localTransform},set:function(e){this.setLocalTransform(e)},enumerable:!0,configurable:!0}),e.prototype.setLocalTransform=function(e){this._localTransform=e},Object.defineProperty(e.prototype,"translation",{get:function(){return this.localTransform.getTranslationPart()},set:function(e){this.setTranslation(e)},enumerable:!0,configurable:!0}),e.prototype.setTranslation=function(e){this.localTransform.setTranslationPart(e)},Object.defineProperty(e.prototype,"scale",{get:function(){return this.localTransform.getScalePart()},set:function(e){this.setScale(e)},enumerable:!0,configurable:!0}),e.prototype.setScale=function(e){this.localTransform.setScalePart(e)},Object.defineProperty(e.prototype,"rotation",{get:function(){return this.localTransform.getRotationPart()},set:function(e){this.setRotation(e)},enumerable:!0,configurable:!0}),e.prototype.setRotation=function(e){this.localTransform.setRotationPart(e)},Object.defineProperty(e.prototype,"worldTransform",{get:function(){var e=this.parent?Z.Matrix2d.transform(this.parent.worldTransform,this.localTransform):this.localTransform;return null!==this._worldTranslation&&e.setTranslationPart(this._worldTranslation),null!==this._worldRotation&&e.setRotationPart(this._worldRotation),null!==this._worldScale&&e.setScalePart(this._worldScale),e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"worldTranslation",{get:function(){return this._worldTranslation},set:function(e){this.setWorldTranslation(e)},enumerable:!0,configurable:!0}),e.prototype.setWorldTranslation=function(e){this._worldTranslation=null===e?null:{x:Math.round(e.x),y:Math.round(e.y)}},Object.defineProperty(e.prototype,"worldRotation",{get:function(){return this._worldRotation},set:function(e){this.setWorldRotation(e)},enumerable:!0,configurable:!0}),e.prototype.setWorldRotation=function(e){this._worldRotation=e},Object.defineProperty(e.prototype,"worldScale",{get:function(){return this._worldScale},set:function(e){this.setWorldScale(e)},enumerable:!0,configurable:!0}),e.prototype.setWorldScale=function(e){this._worldScale=e},Object.defineProperty(e.prototype,"anchorPoint",{get:function(){return this._anchorPoint},set:function(e){this.setAnchorPoint(e)},enumerable:!0,configurable:!0}),e.prototype.setAnchorPoint=function(e){this._anchorPoint=e},Object.defineProperty(e.prototype,"numChildren",{get:function(){return this._children.length},enumerable:!0,configurable:!0}),e.prototype.collapseTransform=function(){var e=this.worldTransform;this.worldTranslation=null,this.worldRotation=null,this.worldScale=null,this.parent?this.localTransform=Z.Matrix2d.invert(this.parent.worldTransform).transform(e):this.localTransform=e,this.localTransform.e=Math.round(this.localTransform.e),this.localTransform.f=Math.round(this.localTransform.f)},e.prototype.getLocalPoint=function(e,t){return Z.Matrix2d.invert(this.worldTransform).transformPoint({x:e,y:t})},e.prototype.childAt=function(e){return this._children[e]},e.prototype.forEachChild=function(e){this._children.forEach(e)},e.prototype.addChild=function(e){null===e._parent&&(e._parent=this,e._view=this._view,this._children.push(e))},e.prototype.removeChild=function(e){if(e._parent===this){var t=this._children.indexOf(e);this.removeChildAt(t)}},e.prototype.removeChildAt=function(e){if(0<=e&&e<this._children.length){var t=this._children[e];this._children.splice(e,1),t._parent=null,t._view=null}},e.prototype.removeChildren=function(){for(;0<this._children.length;)this.removeChildAt(0)},e.prototype.unrefChildren=function(){for(;0<this._children.length;)this._children[0].unrefChildren(),this.removeChildAt(0)},e.prototype.remove=function(){this._parent&&this._parent.removeChild(this)},e.prototype.triggerRecursive=function(n){t.prototype.trigger.call(this,n),this.forEachChild(function(e,t){e.triggerRecursive(n)})},e.prototype.triggerRecursiveEx=function(n){t.prototype.triggerEx.call(this,n),this.forEachChild(function(e,t){e.triggerRecursiveEx(n)})},e.prototype.setCapture=function(){this._view&&this._view.setCaptureObject(this)},e.prototype.releaseCapture=function(){this._view&&this._view.captureObject===this&&this._view.setCaptureObject(null)},e.prototype.toString=function(){return"<SceneObject>"},e}(t.BaseObject=H);t.SceneObject=Y;var X=function(r){function e(e,t){void 0===t&&(t=!1);var i=r.call(this)||this;i._canvas=new q(i,e,t),i._captureObject=null,i._hitObjects=[],i._currentPage=null,i._pages={};var n=new Y;return(n.view=i).addPage({name:"page1",rootNode:n,bkImageUrl:null,bkImageRepeat:null,bkImageSize:null,bkImageAttachment:null,bkColor:"#ffffff"}),i.selectPage("page1"),i.on(v.type,function(e){var t=new u(e.deltaTime,e.elapsedTime,e.frameStamp);i.rootNode&&i.rootNode.triggerRecursiveEx(t),i.canvas.clear(),i.triggerEx(new f(i.canvas,0,new Z.Matrix2d)),i.canvas.flip()}),i.on(f.type,function(e){if(i.rootNode){var t=new p(e.canvas.width,e.canvas.height);for(var n in i.rootNode.triggerRecursiveEx(t),t.result)for(var r=t.result[n],o=0;o<r.length;o++)e.canvas.context.save(),e.canvas.applyTransform(r[o].transform),e.canvas.context.translate(.5,.5),r[o].object.triggerEx(new f(e.canvas,r[o].z,r[o].transform)),e.canvas.context.restore()}}),i}return h(e,r),e.prototype.forEachPage=function(e){if(e)for(var t in this._pages)e({name:t,rootNode:this._pages[t].rootNode,bkImageUrl:this._pages[t].bkImageUrl,bkImageRepeat:this._pages[t].bkImageRepeat,bkImageAttachment:this._pages[t].bkImageAttachment,bkImageSize:this._pages[t].bkImageSize,bkColor:this._pages[t].bkColor})},e.prototype.addPage=function(e){var t={name:null,rootNode:null,bkImageUrl:null,bkImageRepeat:"repeat",bkImageAttachment:"scroll",bkImageSize:"auto",bkColor:"#ffffff"},n=e||t,r=n.name||this.genPageName();return r in this._pages?null:(this._pages[r]={name:r,rootNode:n.rootNode,bkImageUrl:n.bkImageUrl,bkImageRepeat:n.bkImageRepeat||t.bkImageRepeat,bkImageAttachment:n.bkImageAttachment||t.bkImageAttachment,bkImageSize:n.bkImageSize||t.bkImageSize,bkColor:n.bkColor||t.bkColor},r)},e.prototype.removePage=function(e){if(e in this._pages){if(e===this._currentPage){var t=!1;for(var n in this._pages)n!==e&&(this.selectPage(n),t=!0);if(!t)return!1}var r=this._pages[e].rootNode;return r&&(r.unrefChildren(),r.view=null,this._pages[e].rootNode=null),delete this._pages[e],!0}return!1},e.prototype.selectPage=function(e){var t=this._currentPage;e in this._pages&&e!==t&&(K.triggerEvent(null,new N(this,t,e)),this._currentPage=e,this._captureObject=null,this._hitObjects.length=0,this.applyPage(this._pages[this._currentPage]),K.triggerEvent(null,new z(this,t,e)))},e.prototype.renamePage=function(e,t){if(e in this._pages&&t&&t!==e&&!(t in this._pages)){var n=this._pages[e];delete this._pages[e],n.name=t,this._pages[t]=n,e===this._currentPage&&(this._currentPage=t)}},Object.defineProperty(e.prototype,"currentPage",{get:function(){return this._currentPage},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pageImage",{get:function(){return this._currentPage?this._pages[this._currentPage].bkImageUrl:null},set:function(e){this._currentPage&&e!==this._pages[this._currentPage].bkImageUrl&&(this._pages[this._currentPage].bkImageUrl=e,this.applyPage(this._pages[this._currentPage]))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pageImageRepeat",{get:function(){return this._currentPage?this._pages[this._currentPage].bkImageRepeat:null},set:function(e){var t=e||"repeat";this._currentPage&&t!==this._pages[this._currentPage].bkImageRepeat&&(this._pages[this._currentPage].bkImageRepeat=t,this.applyPage(this._pages[this._currentPage]))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pageImageAttachment",{get:function(){return this._currentPage?this._pages[this._currentPage].bkImageAttachment:null},set:function(e){var t=e||"scroll";this._currentPage&&t!==this._pages[this._currentPage].bkImageAttachment&&(this._pages[this._currentPage].bkImageAttachment=t,this.applyPage(this._pages[this._currentPage]))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pageImageSize",{get:function(){return this._currentPage?this._pages[this._currentPage].bkImageSize:null},set:function(e){var t=e||"auto";this._currentPage&&t!==this._pages[this._currentPage].bkImageSize&&(this._pages[this._currentPage].bkImageSize=t,this.applyPage(this._pages[this._currentPage]))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pageColor",{get:function(){return this._currentPage?this._pages[this._currentPage].bkColor:null},set:function(e){this._currentPage&&e!==this._pages[this._currentPage].bkColor&&(this._pages[this._currentPage].bkColor=e,this.applyPage(this._pages[this._currentPage]))},enumerable:!0,configurable:!0}),e.prototype.updateHitObjects=function(e,t){for(var n=this.hitTest(e,t),r=0;r<this._hitObjects.length;)n.indexOf(this._hitObjects[r])<0?(this._hitObjects[r].trigger(new S),this._hitObjects.splice(r,1)):r++;for(r=0;r<n.length;r++)this._hitObjects.indexOf(n[r])<0&&n[r].trigger(new k);this._hitObjects=n,this.rootNode&&this._hitObjects.push(this.rootNode)},Object.defineProperty(e.prototype,"rootNode",{get:function(){if(this._currentPage){var e=this._pages[this._currentPage].rootNode;return e||(((e=new Y).view=this)._pages[this._currentPage].rootNode=e),e}return null},set:function(e){this._currentPage&&this._pages[this._currentPage].rootNode!==e&&(this._pages[this._currentPage].rootNode=e,this._hitObjects.length=0,this._captureObject=null)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"canvas",{get:function(){return this._canvas},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"captureObject",{get:function(){return this._captureObject},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hitObjects",{get:function(){return this._hitObjects},enumerable:!0,configurable:!0}),e.prototype.setCaptureObject=function(e){this._captureObject=e},e.prototype.handleMouseDown=function(e){var t=this.canvas.viewport_rect,n=new x(e.clientX-t.x,e.clientY-t.y,e.button,e.shiftKey,e.altKey,e.ctrlKey,e.metaKey);if(this.isValidObject(this._captureObject))this._captureObject.triggerEx(n);else{for(var r=0;r<this._hitObjects.length;r++){var o=this._hitObjects[r];if(this.isValidObject(o)&&(o.triggerEx(n),!n.bubble))break}n.bubble&&this.triggerEx(n)}},e.prototype.handleMouseUp=function(e){var t=this.canvas.viewport_rect,n=new T(e.clientX-t.x,e.clientY-t.y,e.button,e.shiftKey,e.altKey,e.ctrlKey,e.metaKey);if(this.isValidObject(this._captureObject))this._captureObject.triggerEx(n);else{for(var r=0;r<this._hitObjects.length;r++){var o=this._hitObjects[r];if(this.isValidObject(o)&&(o.triggerEx(n),!n.bubble))break}n.bubble&&this.triggerEx(n)}},e.prototype.handleMouseMove=function(e){var t=this.canvas.viewport_rect,n=new j(e.clientX-t.x,e.clientY-t.y,e.button,e.shiftKey,e.altKey,e.ctrlKey,e.metaKey);if(this.isValidObject(this._captureObject))this._captureObject.triggerEx(n);else{for(var r=0;r<this._hitObjects.length;r++){var o=this._hitObjects[r];if(this.isValidObject(o)&&(o.triggerEx(n),!n.bubble))break}n.bubble&&this.triggerEx(n)}},e.prototype.handleClick=function(e){for(var t=this.canvas.viewport_rect,n=new E(e.clientX-t.x,e.clientY-t.y,e.button,e.shiftKey,e.altKey,e.ctrlKey,e.metaKey),r=0;r<this._hitObjects.length;r++){var o=this._hitObjects[r];if(this.isValidObject(o)&&(o.triggerEx(n),!n.bubble))break}n.bubble&&this.triggerEx(n)},e.prototype.handleDblClick=function(e){for(var t=this.canvas.viewport_rect,n=new O(e.clientX-t.x,e.clientY-t.y,e.button,e.shiftKey,e.altKey,e.ctrlKey,e.metaKey),r=0;r<this._hitObjects.length;r++){var o=this._hitObjects[r];if(this.isValidObject(o)&&(o.triggerEx(n),!n.bubble))break}n.bubble&&this.triggerEx(n)},e.prototype.setFocus=function(){K.setFocusView(this)},e.prototype.hitTest=function(i,a){var e=[];return this.rootNode&&(!function n(e,r){var t=Z.Matrix2d.invert(e.worldTransform).transformPoint({x:i,y:a}),o=new d(t.x,t.y);e.triggerEx(o),o.result&&r.push(e),e.forEachChild(function(e,t){n(e,r)})}(this.rootNode,e),e.sort(function(e,t){return t.z-e.z})),e},e.prototype.isValidObject=function(e){return e&&e.view===this},e.prototype.genPageName=function(){for(var e=1;;){var t="page"+e++;if(!(t in this._pages))return t}},e.prototype.applyPage=function(e){var t=e.bkColor||"",n=e.bkImageUrl&&"url("+e.bkImageUrl+")"||"",r=e.bkImageRepeat||"repeat",o=e.bkImageAttachment||"scroll",i=e.bkImageSize||"auto";this._canvas.canvas.style.background=t+" "+n+" "+r+" "+o+" 0% 0% / "+i},e}(H);function U(r,o){var e=parseInt(window.getComputedStyle(r).zIndex||"0",10);isNaN(e)&&(e=0),e--;var t=document.createElement("div");t.style.position="absolute",t.style.left="0px",t.style.top="0px",t.style.right="0px",t.style.bottom="0px",t.style.overflow="hidden",t.style.zIndex=String(e),t.style.visibility="hidden";var n=document.createElement("div");n.style.position="absolute",n.style.left="0px",n.style.top="0px",n.style.width="10000000px",n.style.height="10000000px",t.appendChild(n);var i=document.createElement("div");i.style.position="absolute",i.style.left="0px",i.style.top="0px",i.style.right="0px",i.style.bottom="0px",i.style.overflow="hidden",i.style.zIndex=String(e),i.style.visibility="hidden";var a=document.createElement("div");function s(){t.scrollLeft=1e7,t.scrollTop=1e7,i.scrollLeft=1e7,i.scrollTop=1e7}a.style.position="absolute",a.style.left="0px",a.style.top="0px",a.style.width="200%",a.style.height="200%",i.appendChild(a),r.appendChild(t),r.appendChild(i),s();var c=r.getBoundingClientRect(),l=c.width,u=c.height,p=function(){var e=r.getBoundingClientRect(),t=e.width,n=e.height;t===l&&n===u||(l=t,u=n,o()),s()};t.addEventListener("scroll",p),i.addEventListener("scroll",p)}t.SceneView=X,t.ResizeSensor=U;var q=function(o){function e(e,t,n){void 0===n&&(n=!1);var r=o.call(this)||this;return r._view=e,r._canvas=t,r._buffer=null,r._screenCtx=null,r._offscreenCtx=null,r._width=0,r._height=0,r._canvas&&(r.adjustCanvasSize(r._canvas),r._canvas.parentElement&&U(r._canvas.parentElement,function(){r.adjustCanvasSize(r._canvas)})),r._mouseOver=!1,r._doubleBuffer=n,r}return h(e,o),Object.defineProperty(e.prototype,"canvas",{get:function(){return this._canvas},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"context",{get:function(){return this._doubleBuffer?this._offscreenCtx:this._screenCtx},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"viewport_rect",{get:function(){var e=this._canvas.getBoundingClientRect();return{x:e.left-document.documentElement.clientLeft,y:e.top-document.documentElement.clientTop,w:e.right-e.left,h:e.bottom-e.top}},enumerable:!0,configurable:!0}),e.prototype.clear=function(e){var t=e?e.x:0,n=e?e.y:0,r=e?e.w:this._width,o=e?e.h:this._height;this.context.setTransform(1,0,0,1,0,0),this.context.clearRect(t,n,r,o),this._doubleBuffer&&this._screenCtx&&this._screenCtx.clearRect(t,n,r,o)},e.prototype.applyTransform=function(e){this.context.setTransform(e.a,e.b,e.c,e.d,Math.round(e.e),Math.round(e.f))},e.prototype.flip=function(){this._doubleBuffer&&this._screenCtx&&this._buffer&&this._screenCtx.drawImage(this._buffer,0,0)},e.prototype.adjustCanvasSize=function(e){if(e.parentElement){var t=window.getComputedStyle(e.parentElement);this._width=e.parentElement.clientWidth-parseFloat(t.paddingLeft)-parseFloat(t.paddingRight),this._height=e.parentElement.clientHeight-parseFloat(t.paddingTop)-parseFloat(t.paddingBottom),this._canvas.width=this._width,this._canvas.height=this._height,this._screenCtx=this._canvas.getContext("2d"),this._buffer=document.createElement("canvas"),this._buffer.width=this._width,this._buffer.height=this._height,this._offscreenCtx=this._buffer.getContext("2d"),K.triggerEvent(null,new F(this._view))}},e}(H);t.Canvas=q});t(u);u.EventListenerOrder,u.BaseEvent,u.EvtComponentBeforeAttach,u.EvtComponentAttached,u.EvtComponentBeforeDetach,u.EvtComponentDetached,u.EvtUpdate,u.EvtCull,u.EvtDraw,u.EvtHitTest,u.EvtGetBoundingShape,u.EvtFrame,u.EvtFocus,u.EvtKeyboard,u.EvtKeyDown,u.EvtKeyUp,u.EvtKeyPress,u.EvtMouse,u.EvtMouseDown,u.EvtMouseUp,u.EvtMouseMove,u.EvtMouseEnter,u.EvtMouseLeave,u.EvtClick,u.EvtDblClick,u.EvtDragBegin,u.EvtDragEnd,u.EvtDragging,u.EvtDragOver,u.EvtDragDrop,u.EvtResize,u.EvtCanvasResize,u.EvtGetProp,u.EvtSetProp,u.EvtSceneViewPageWillChange,u.EvtSceneViewPageChanged,u.EvtSysInfo,u.EventObserver,u.App,u.Component,u.BaseObject,u.SceneObject,u.SceneView,u.ResizeSensor,u.Canvas;var a=n(function(e,t){var r,n=Q&&Q.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var o=function(s){function c(e){var i=s.call(this,c.type)||this;i._tracks={},i._duration=0,i._startTime=0,i._round=0;var t=e||{};if(i._delay=void 0===t.delay?0:t.delay,i._repeat=void 0===t.repeat?0:t.repeat,i._autoRemove=void 0===t.autoRemove||t.autoRemove,i._exclusive=!!t.exclusive,t.tracks)for(var n in t.tracks)if(t.tracks.hasOwnProperty(n)){var r=t.tracks[n],o=void 0===r.type?l.SplineType.POLY:r.type,a=void 0===r.clamp||r.clamp;i.setTrack(n,o,a,r.cp)}return i.on(u.EvtComponentBeforeAttach.type,function(e){e.object&&i._exclusive&&e.object.removeComponentsByType(i.type)}),i.on(u.EvtUpdate.type,function(e){var t=e.elapsedTime;if(0===i._startTime&&(i._startTime=t),!(i._startTime+i._delay>t)){var n=t-i._startTime-i._delay;for(var r in i._tracks)i._tracks.hasOwnProperty(r)&&(i._tracks[r].value=i._tracks[r].evalutor.eval(n));if(i.object)for(var o in i._tracks)i._tracks.hasOwnProperty(o)&&i.object.triggerEx(new u.EvtSetProp(o,i._tracks[o].value));n>=i._duration&&(i._round++,0===i._repeat||i._round<i._repeat?i._startTime=t+n-i._duration:i._autoRemove&&i.object&&i.object.removeComponent(i))}}),i}return n(c,s),Object.defineProperty(c.prototype,"repeat",{get:function(){return this._repeat},set:function(e){this._repeat=e},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"autoRemove",{get:function(){return this._autoRemove},set:function(e){this._autoRemove=e},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"delay",{get:function(){return this._delay},set:function(e){this._delay=e},enumerable:!0,configurable:!0}),c.prototype.setTrack=function(e,t,n,r){0<r.length&&(r[r.length-1].x>this._duration&&(this._duration=r[r.length-1].x),this._tracks[e]={evalutor:new l.Spline(t,r,n),value:null})},c.prototype.finish=function(){for(var e in this._tracks)this._tracks[e].value=this._tracks[e].evalutor.evalLast();if(this.object)for(var t in this._tracks)this.object.triggerEx(new u.EvtSetProp(t,this._tracks[t].value));this._round++,0===this._repeat||this._round<this._repeat?this._startTime=u.App.elapsedTime:this._autoRemove&&this.object&&this.object.removeComponent(this)},c.type="KeyframeAnimation",c}(u.Component);t.CoKeyframeAnimation=o;var i=function(e){function t(){var a=e.call(this,t.type)||this;return a._dragging=!1,a._draggingData=null,a.on(u.EvtMouseDown.type,function(e){var t=a.object;t.setCapture(),a._dragging=!0;var n=new u.EvtDragBegin(e.x,e.y,e.button,e.shiftDown,e.altDown,e.ctrlDown,e.metaDown);t.triggerEx(n),a._draggingData=n.data,e.cancelBubble()}),a.on(u.EvtMouseUp.type,function(e){var t=a.object;if(t.releaseCapture(),t.view&&a._dragging){var n=new u.EvtDragEnd(e.x,e.y,e.button,e.shiftDown,e.altDown,e.ctrlDown,e.metaDown,a._draggingData);t.triggerEx(n),a._dragging=!1,t.view.updateHitObjects(e.x,e.y);for(var r=new u.EvtDragDrop(e.x,e.y,e.button,e.shiftDown,e.altDown,e.ctrlDown,e.metaDown,t,a._draggingData),o=0;o<t.view.hitObjects.length;o++){var i=t.view.hitObjects[o];if(i!==t&&i.z<=t.z&&(i.triggerEx(r),!r.bubble))break}r.bubble&&t.view.triggerEx(r),a._draggingData=null,e.cancelBubble()}}),a.on(u.EvtMouseMove.type,function(e){if(a.object&&a._dragging){var t=new u.EvtDragging(e.x,e.y,e.button,e.shiftDown,e.altDown,e.ctrlDown,e.metaDown,a._draggingData);a.object.triggerEx(t);var n=a.object;if(n.view){n.view.updateHitObjects(e.x,e.y);for(var r=new u.EvtDragOver(e.x,e.y,e.button,e.shiftDown,e.altDown,e.ctrlDown,e.metaDown,n,a._draggingData),o=0;o<n.view.hitObjects.length;o++){var i=n.view.hitObjects[o];if(i!==n&&i.z<=n.z&&(i.triggerEx(r),!r.bubble))break}r.bubble&&n.view.triggerEx(r),e.cancelBubble()}}}),a}return n(t,e),t.type="Draggable",t}(u.Component);t.CoDraggable=i;var a=function(e){function t(){return e.call(this,t.type)||this}return n(t,e),t.type="Droppable",t}(u.Component);t.CoDroppable=a;var s=function(o){function i(e,t,n){void 0===e&&(e=null),void 0===t&&(t=0),void 0===n&&(n=0);var r=o.call(this,i.type)||this;return r._image=new Image,e&&(r._image.src=e),r._width=t?r._image.width=t:r._image.complete?r._image.width:0,r._height=n?r._image.height=n:r._image.complete?r._image.height:0,r._image.complete?r._loaded=!0:(r._loaded=!1,r._image.onload=function(){0===r._width&&(r._width=r._image.width),0===r._height&&(r._height=r._image.height),r._loaded=!0}),r.on(u.EvtCull.type,function(e){if(r._loaded){var t=r.object;e.addObject(r,t.z,t.worldTransform)}}),r.on(u.EvtGetBoundingShape.type,function(e){r.object&&r._loaded&&(e.shape=new m.BoundingBox({x:-r._width*r.object.anchorPoint.x,y:-r._height*r.object.anchorPoint.y,w:r._width,h:r._height}))}),r.on(u.EvtDraw.type,function(e){r.object&&r._loaded&&e.canvas.context.drawImage(r._image,-Math.round(r._width*r.object.anchorPoint.x)-.5,-Math.round(r._height*r.object.anchorPoint.y)-.5,r._width,r._height)}),r.on(u.EvtGetProp.type,function(e){switch(e.propName){case"width":e.propValue=r._width,e.eat();break;case"height":e.propValue=r._height,e.eat()}}),r.on(u.EvtSetProp.type,function(e){switch(e.propName){case"width":r._width=e.propValue,r._image.width=r._width,e.eat();break;case"height":r._height=e.propValue,r._image.height=r._height,e.eat()}}),r}return n(i,o),i.type="Image",i}(u.Component);t.CoImage=s});t(a);a.CoKeyframeAnimation,a.CoDraggable,a.CoDroppable,a.CoImage;var s=n(function(e,t){function w(e,t,n,r,o,i,a,s){var c=4*(o*t+r);e[c]=i,e[c+1]=a,e[c+2]=s,e[c+3]=255}Object.defineProperty(t,"__esModule",{value:!0});var v=null;function h(e){for(var t={r:255,g:255,b:255,a:255},n=[],r=0,o=(e.toLowerCase(),"0".charCodeAt(0)),i="9".charCodeAt(0),a="a".charCodeAt(0),s="f".charCodeAt(0),c=1;c<e.length;c++){var l=e.charCodeAt(c),u=0;o<=l&&l<=i?u=l-o:a<=l&&l<=s&&(u=10+l-a),c%2==1?r=u:n.push(16*r+u)}return 0<n.length&&(t.r=n[0]),1<n.length&&(t.g=n[1]),2<n.length&&(t.b=n[2]),3<n.length&&(t.a=n[3]),t}t.DrawLine=function(e,t,n,r,o,i){var a=h(i),s=r<t?r:t,c=o<n?o:n,l=r<t?t:r,u=o<n?n:o,p=e.getImageData(s,c,l-s+1,u-c+1);!function(e,t,n,r,o,i,a,s,c,l){var u,p=Math.abs(i-r),h=Math.abs(a-o),f=0;p<h&&(f=1,u=r,r=o,o=u,u=i,i=a,a=u,u=p,p=h,h=u);var d=r<i?1:-1,y=o<a?1:-1,v=r,g=o,m=2*h,_=2*(h-p),b=2*h-p;if(1===f)for(;v!==i;)b<0?b+=m:(g+=y,b+=_),w(e,t,0,g,v,s,c,l),v+=d;else for(;v!==i;)b<0?b+=m:(g+=y,b+=_),w(e,t,0,v,g,s,c,l),v+=d}(p.data,p.width,p.height,t-s,n-c,r-s,o-c,a.r,a.g,a.b),e.putImageData(p,s,c)},t.FillCircle=function(e,t,n,r,o){var i=h(o),a=e.getImageData(t-r,n-r,2*r+1,2*r+1);!function(e,s,t,c,l,u,p,h,f){function n(e,t){var n=v,r=e-c,o=t-l,i=1-Math.sqrt((r*r+o*o)/(u*u)),a=4*(t*s+e);n[a]=p*i,n[a+1]=h*i,n[a+2]=f*i,n[a+3]=255*i}(null===v||v.length<e.length)&&(v=new Uint8ClampedArray(e.length));var r,o=0,i=u,a=3,d=2-u-u,y=1-u;for(n(o+c,i+l),n(o+c,-i+l),r=-u+c;r<=u+c;r++)n(r,l);for(;o<i;){for(y<0?(y+=a,a+=2,o++):(y+=a+d,a+=2,d+=2,o++,i--),r=-o+c;r<=o+c;r++)n(r,-i+l),n(r,i+l);for(r=-i+c;r<=i+c;r++)n(r,-o+l),n(r,o+l)}!function(e,t){for(var n=0;n<e.length/4;n++){var r=1-t[4*n+3]/255;e[4*n]=e[4*n]*r+t[4*n],e[4*n+1]=e[4*n+1]*r+t[4*n+1],e[4*n+2]=e[4*n+2]*r+t[4*n+2],e[4*n+3]<t[4*n+3]&&(e[4*n+3]=t[4*n+3])}}(e,v)}(a.data,a.width,a.height,r,r,r,i.r,i.g,i.b),e.putImageData(a,t-r,n-r)}});t(s);s.DrawLine,s.FillCircle;var y=n(function(e,n){function t(e){for(var t in e)n.hasOwnProperty(t)||(n[t]=e[t])}Object.defineProperty(n,"__esModule",{value:!0}),t(v),t(i),t(m),t(g),t(_),t(b),t(J),t(l),t(o),t(Z),t(u),t(a),t(s)});t(y);var h=n(function(e,t){var r,a=Q&&Q.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var n=function(r){function o(e,t){var n=r.call(this,o.type)||this;return n.messageType=e,n.messageData=t,n}return a(o,r),o.type="@socketMessage",o}(y.BaseEvent);t.EvtSocketMessage=n;var o=function(e){function t(){var r=e.call(this,t.type)||this;return r.on(u.type,function(e){e.tool.activateObject(r.object)}),r.on(s.type,function(e){e.tool.deactivateObject(r.object)}),r.on(x.type,function(e){var t=r.object;switch(e.name){case"localx":(n=t.translation).x=Number(e.value),t.translation=n;break;case"localy":(n=t.translation).y=Number(e.value),t.translation=n;break;case"anchorx":(n=t.anchorPoint).x=Number(e.value),t.anchorPoint=n;break;case"anchory":var n;(n=t.anchorPoint).y=Number(e.value),t.anchorPoint=n;break;case"entityName":t.entityName=e.value}}),r.on(l.type,function(e){var t=r.object;switch(e.name){case"localx":e.value=t.translation.x;break;case"localy":e.value=t.translation.y;break;case"anchorx":e.value=t.anchorPoint.x;break;case"anchory":e.value=t.anchorPoint.y;break;case"entityName":e.value=t.entityName;break;case"entityType":e.value=t.entityType}}),r.on(c.type,function(e){e.properties=e.properties||{},e.properties.general=e.properties.general||{desc:"通用",properties:[]},e.properties.general.properties.push({name:"entityType",desc:"类型",readonly:!0,type:"string",value:r.object?r.object.entityType:null}),e.properties.general.properties.push({name:"entityName",desc:"名称",readonly:!1,type:"string",value:r.object?r.object.entityName:null}),e.properties.general.properties.push({name:"localx",desc:"位置X",readonly:!1,type:"number",value:r.object?r.object.translation.x:null}),e.properties.general.properties.push({name:"localy",desc:"位置Y",readonly:!1,type:"number",value:r.object?r.object.translation.y:null}),e.properties.general.properties.push({name:"anchorx",desc:"锚点X",readonly:!1,type:"number",value:r.object?r.object.anchorPoint.x:null}),e.properties.general.properties.push({name:"anchory",desc:"锚点Y",readonly:!1,type:"number",value:r.object?r.object.anchorPoint.y:null})}),r}return a(t,e),t.type="WBComponent",t}(y.Component);t.WBComponent=o;var i=function(){function e(e){this.name=e}return e.prototype.createEntity=function(e,t,n){var r=this._createEntity(n);return null===r?null:(r.addComponent(new o),r.translation={x:e,y:t},r)},e.prototype.getCreationProperties=function(){return[]},e}();t.WBFactory=i;var u=function(n){function r(e){var t=n.call(this,r.type)||this;return t.tool=e,t}return a(r,n),r.type="@WBToolActivate",r}(y.BaseEvent);t.WBToolActivateEvent=u;var s=function(n){function r(e){var t=n.call(this,r.type)||this;return t.tool=e,t}return a(r,n),r.type="@WBToolDeactivate",r}(y.BaseEvent);t.WBToolDeactivateEvent=s;var c=function(e){function t(){return e.call(this,t.type)||this}return a(t,e),t.type="@WBGetObjectPropertyList",t}(y.BaseEvent);t.WBGetPropertyListEvent=c;var x=function(r){function o(e,t){var n=r.call(this,o.type)||this;return n.name=e,n.value=t,n}return a(o,r),o.type="@WBSetObjectPropertyEvent",o}(y.BaseEvent);t.WBSetPropertyEvent=x;var l=function(n){function r(e){var t=n.call(this,r.type)||this;return t.name=e,t}return a(r,n),r.type="@WBGetObjectPropertyEvent",r}(y.BaseEvent);t.WBGetPropertyEvent=l;var p=function(n){function r(e){var t=n.call(this,r.type)||this;return t.name=e,t}return a(r,n),r.type="@WBGetObject",r}(y.BaseEvent);t.WBGetObjectEvent=p;var h=function(o){function i(e,t,n){var r=o.call(this,i.type)||this;return r.command=e,r.args=t,r.results=n,r}return a(i,o),i.type="@WBCommand",i}(y.BaseEvent);t.WBCommandEvent=h;var f=function(o){function e(e,t,n){var r=o.call(this)||this;return r.name=e,r.desc=n||e,r._wb=t,r.on(l.type,function(e){switch(e.name){case"desc":e.value=r.desc}}),r.on(c.type,function(e){e.properties=e.properties||{}}),r}return a(e,o),e.prototype.activate=function(e){y.App.triggerEvent(null,new u(this))},e.prototype.deactivate=function(){y.App.triggerEvent(null,new s(this))},e.prototype.activateObject=function(e){},e.prototype.deactivateObject=function(e){},e.prototype.executeCommand=function(e,t){},e}(y.EventObserver);t.WBTool=f;var d=function(r){function e(e,t){void 0===t&&(t=!1);var n=r.call(this)||this;return n.view=null,n.view=y.App.addCanvas(e,t),n._factories={},n._tools={},n._currentTool="",n._entities={},n.on(p.type,function(e){e.object=n.findEntity(e.name)}),n.on(y.EvtSceneViewPageWillChange.type,function(e){var t=n._tools[n._currentTool];t&&t.deactivate()}),n.on(y.EvtSceneViewPageChanged.type,function(e){var t=n._tools[n._currentTool];t&&t.activate()}),n.on(h.type,function(e){n._executeCommand(e.command,e.args,e.results)}),n.view&&(n.view.on(y.EvtKeyDown.type,function(e){""!==n._currentTool&&n._tools[n._currentTool].trigger(e)}),n.view.on(y.EvtKeyUp.type,function(e){""!==n._currentTool&&n._tools[n._currentTool].trigger(e)}),n.view.on(y.EvtKeyPress.type,function(e){""!==n._currentTool&&n._tools[n._currentTool].trigger(e)}),n.view.on(y.EvtMouseDown.type,function(e){""!==n._currentTool&&n._tools[n._currentTool].trigger(e)}),n.view.on(y.EvtMouseUp.type,function(e){""!==n._currentTool&&n._tools[n._currentTool].trigger(e)}),n.view.on(y.EvtMouseMove.type,function(e){""!==n._currentTool&&n._tools[n._currentTool].trigger(e)}),n.view.on(y.EvtClick.type,function(e){""!==n._currentTool&&n._tools[n._currentTool].trigger(e)}),n.view.on(y.EvtDblClick.type,function(e){""!==n._currentTool&&n._tools[n._currentTool].trigger(e)}),n.view.on(y.EvtDraw.type,function(e){""!==n._currentTool&&n._tools[n._currentTool].trigger(e)},y.EventListenerOrder.LAST)),n}return a(e,r),e.prototype.addTool=function(e){this._tools[e.name]=e},e.prototype.addFactory=function(e){this._factories[e.name]=e},e.prototype.getFactory=function(e){return this._factories[e]||null},e.prototype.createEntity=function(e,t,n,r,o,i){var a=null;if(null===t)for(var s=1;t=""+e.toLowerCase()+s++,null!==this.findEntity(t););else if(null!==(a=this.findEntity(t)))return n?null:a;var c=this._factories[e];if(c&&(a=c.createEntity(r,o,i))&&(a.entityName=t,a.entityType=e,this.view&&this.view.rootNode&&this.view.rootNode.addChild(a),this._entities[t]=a,""!==this._currentTool)){var l=this._tools[this._currentTool];l&&a.triggerEx(new u(l))}return a},e.prototype.deleteEntity=function(e){var t=this.findEntity(e);t&&(t.remove(),delete this._entities[e])},e.prototype.findEntity=function(e){return this._entities[e]||null},e.prototype.encodeCommand=function(e){return JSON.stringify(e)},e.prototype._executeCommand=function(e,t,n){var r=this,o=t||{};if("UseTool"===e){if(this._currentTool!==o.name){if(""!==this._currentTool)this._tools[this._currentTool].deactivate();if(this._currentTool="",o.name){var i=this._tools[o.name];i&&(this._currentTool=o.name,i.activate(o.args||{}))}}}else if("CreateObject"===e){var a=o.type,s=o.name||null,c=!!o.failOnExists,l=o.params||{},u=this.createEntity(a,s,c,o.x,o.y,l);n&&(n.objectCreated=u)}else if("DeleteObject"===e)this.deleteEntity(o.name);else if("DeleteObjects"===e)o.objects&&o.objects.forEach(function(e){r.deleteEntity(e)});else if("AlignObjectsLeft"===e){if(o.objects&&1<o.objects.length){for(var p=(w=o.objects.map(function(e){return r.findEntity(e)}))[0].worldTransform.e,h=1;h<w.length;h++){(d=w[h].worldTransform.e)<p&&(p=d)}w.forEach(function(e){e.worldTranslation={x:p,y:e.worldTransform.f},e.collapseTransform()})}}else if("AlignObjectsRight"===e){if(o.objects&&1<o.objects.length){var f=(w=o.objects.map(function(e){return r.findEntity(e)}))[0].worldTransform.e;for(h=1;h<w.length;h++){var d=w[h].worldTransform.e;f<d&&(f=d)}w.forEach(function(e){e.worldTranslation={x:f,y:e.worldTransform.f},e.collapseTransform()})}}else if("AlignObjectsTop"===e){if(o.objects&&1<o.objects.length){var y=(w=o.objects.map(function(e){return r.findEntity(e)}))[0].worldTransform.f;for(h=1;h<w.length;h++){(g=w[h].worldTransform.f)<y&&(y=g)}w.forEach(function(e){e.worldTranslation={x:e.worldTransform.e,y:y},e.collapseTransform()})}}else if("AlignObjectsBottom"===e){if(o.objects&&1<o.objects.length){var v=(w=o.objects.map(function(e){return r.findEntity(e)}))[0].worldTransform.f;for(h=1;h<w.length;h++){var g=w[h].worldTransform.f;v<g&&(v=g)}w.forEach(function(e){e.worldTranslation={x:e.worldTransform.e,y:v},e.collapseTransform()})}}else if("AlignObjectsHorizontal"===e){if(o.objects&&1<o.objects.length){var m=this.findEntity(o.objects[0]);if(m)for(g=m.worldTransform.f,h=1;h<o.objects.length;h++){(u=this.findEntity(o.objects[h]))&&(u.worldTranslation={x:u.worldTransform.e,y:g},u.collapseTransform())}}}else if("ArrangeObjectsHorizontal"===e){if(o.objects&&2<o.objects.length){(w=o.objects.map(function(e){return r.findEntity(e)})).sort(function(e,t){return e.worldTransform.e-t.worldTransform.e});var _=w[0].worldTransform.e,b=(w[w.length-1].worldTransform.e-_)/(w.length-1);for(h=1;h<w.length-1;h++)w[h].worldTranslation={x:_+h*b,y:w[h].worldTransform.f},w[h].collapseTransform()}}else if("ArrangeObjectsVertical"===e){if(o.objects&&2<o.objects.length){var w;(w=o.objects.map(function(e){return r.findEntity(e)})).sort(function(e,t){return e.worldTransform.f-t.worldTransform.f});for(_=w[0].worldTransform.f,b=(w[w.length-1].worldTransform.f-_)/(w.length-1),h=1;h<w.length-1;h++)w[h].worldTranslation={x:w[h].worldTransform.e,y:_+h*b},w[h].collapseTransform()}}else if("SetObjectProperty"===e){if(u=this.findEntity(o.objectName)){var P=new x(o.propName,o.propValue);u.triggerEx(P),u.entityName!==o.objectName&&(this.findEntity(u.entityName)?u.entityName=o.objectName:(delete this._entities[o.objectName],this._entities[u.entityName]=u))}}else if("AddPage"===e)this.view&&this.view.addPage();else if("RenamePage"===e)this.view&&this.view.currentPage&&this.view.renamePage(this.view.currentPage,o.newName);else{if(!this._currentTool)return;this._tools[this._currentTool].executeCommand(e,o)}},e}(y.EventObserver);t.WhiteBoard=d});t(h);h.EvtSocketMessage,h.WBComponent,h.WBFactory,h.WBToolActivateEvent,h.WBToolDeactivateEvent,h.WBGetPropertyListEvent,h.WBSetPropertyEvent,h.WBGetPropertyEvent,h.WBGetObjectEvent,h.WBCommandEvent,h.WBTool,h.WhiteBoard;var c=n(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function o(e,t){this._editor=e,this._container=t,this._tools=[],this._curTool=null}return o.prototype.unload=function(){for(;this._container.hasChildNodes();)this._container.removeChild(this._container.firstChild);this._tools=[]},o.prototype.loadToolPalette=function(n){var i=this,e=function(e){var t=r.getOpTool(n,e),o=r.createToolButton(t);o&&o.addEventListener("click",function(){var e=Number(o.getAttribute("toolIndex")),t=i._tools[e];if(t!==i._curTool&&i._curTool){var n=document.querySelector("#"+i._curTool.elementId);n&&n.classList.remove("active"),i._editor.executeCommand("UseTool"),i._curTool=null}if(t){var r=document.querySelector("#"+t.elementId);r&&r.classList.add("active"),i._editor.executeCommand(t.command,t.args),i._curTool=t}})},r=this;for(var t in n)e(t)},o.prototype.loadOpPalette=function(r){var o=this,e=function(e){var t=i.getOpTool(r,e),n=i.createToolButton(t);n&&n.addEventListener("click",function(){var e=Number(n.getAttribute("toolIndex")),t=o._tools[e];o._editor.executeCommand(t.command,t.args)})},i=this;for(var t in r)e(t)},o.prototype.getOpTool=function(e,t){return{command:e[t].command,args:e[t].args,iconClass:e[t].iconClass}},o.prototype.createToolButton=function(e){this._tools.push(e);var t=this._editor.toolFontSize+6,n=null;if("function"==typeof e.iconClass)(n=e.iconClass(this._editor))&&n.classList.add("toolbutton");else{(n=document.createElement("div")).classList.add("flex-h","flex-align-x-center","flex-align-y-center"),n.classList.add("toolbutton");var r=document.createElement("i");r.style.fontSize=this._editor.toolFontSize+"px",r.style.color="#fff",e.iconClass.split(" ").forEach(function(e){r.classList.add(e)}),n.appendChild(r)}return n&&(e.elementId="toolbutton-"+o.uniqueId++,n.setAttribute("id",e.elementId),n.style.width=t+"px",n.style.height=t+"px",n.setAttribute("toolIndex",String(this._tools.length-1)),this._container.appendChild(n)),n},o.uniqueId=1,o}();t.WBToolPalette=a;var s=function(){function e(e,t,n){this._editor=e,this._container=t,this._tableId=n,this._object=null;var r=document.createElement("table");r.style.border="solid 1px #95B8E7",r.style.borderSpacing="0px",r.style.margin="0px",r.style.fontSize="12px",r.style.fontFamily="verdana",r.style.width="100%",r.style.tableLayout="fixed",r.style.backgroundColor="#fff",r.setAttribute("id",this._tableId);var o=document.createElement("tbody");r.appendChild(o),this._container.appendChild(r)}return e.prototype.addGroup=function(e){var t=this.createRow();t.style.backgroundColor="#E0ECFF",t.style.fontWeight="bold",this.createGroupCell(t,e)},e.prototype.addButton=function(e,t){var n=this.createRow(),r=this.createCell(n);r.style.padding="5px",r.style.textAlign="center",r.setAttribute("colspan","2");var o=document.createElement("button");o.innerText=e,o.style.width="100%",o.style.padding="5px",o.onclick=function(){t&&t()},r.appendChild(o)},e.prototype.addTextAttribute=function(e,t,n,r,o){var i=this.createRow();this.createPropCell(i).innerText=e;var a=document.createElement("input");a.type="text",t&&(a.value=t),a.style.width="100%",a.style.boxSizing="border-box",a.readOnly=n,a.disabled=n,r&&(o?a.onchange=a.onblur=function(){a.value=String(r(a.value))}:a.oninput=function(){a.value=String(r(a.value))}),this.createPropCell(i).appendChild(a)},e.prototype.addToggleAttribute=function(e,t,n,r){var o=this.createRow();this.createPropCell(o).innerText=e;var i=document.createElement("input");i.type="checkbox",i.checked=t,i.readOnly=n,i.disabled=n,r&&(i.onchange=function(){i.checked=Boolean(r(i.checked))}),this.createPropCell(o).appendChild(i)},e.prototype.addNumberAttribute=function(e,t,n,r){var o=this.createRow();this.createPropCell(o).innerText=e;var i=document.createElement("input");i.type="number",i.value=String(t),i.readOnly=n,i.disabled=n,i.style.width="100%",i.style.boxSizing="border-box",r&&(i.oninput=function(){i.value=String(r(Number(i.value)))}),this.createPropCell(o).appendChild(i)},e.prototype.addChoiceAttribute=function(e,t,n,r,o){var i=this.createRow();this.createPropCell(i).innerText=e;var a=document.createElement("select");t.forEach(function(e){var t=document.createElement("option");t.value=String(e.value),t.innerText=String(e.desc),a.add(t)}),n&&(a.value=String(n)),a.disabled=r,a.style.width="100%",a.style.boxSizing="border-box",o&&(a.onchange=function(){a.value=String(o(a.value))}),this.createPropCell(i).appendChild(a)},e.prototype.addColorAttribute=function(e,t,n,r){var o=this.createRow();this.createPropCell(o).innerText=e;var i=document.createElement("input");i.type="color",i.value=t,i.readOnly=n,i.disabled=n,i.style.width="100%",i.style.boxSizing="border-box",r&&(i.onchange=function(){i.value=String(r(i.value))}),this.createPropCell(o).appendChild(i)},e.prototype.getToolProperty=function(e){if(this._object){var t=new h.WBGetPropertyEvent(e);return this._object.triggerEx(t),t.value}},e.prototype.setToolProperty=function(e,t){if(this._object){var n=new h.WBSetPropertyEvent(e,t);this._object.triggerEx(n)}},e.prototype.addToolProperty=function(e){var t=this,n=e.name,r=e.type,o=e.readonly;if(e.enum)this.addChoiceAttribute(e.desc,e.enum,this.getToolProperty(n),o,function(e){switch(r){case"string":return t.setToolProperty(n,e),t.getToolProperty(n);case"number":return t.setToolProperty(n,Number(e)),t.getToolProperty(n);case"boolean":return t.setToolProperty(n,Boolean(e)),t.getObjectProperty(n);case"color":return t.setToolProperty(n,e),t.getToolProperty(n)}});else switch(r){case"string":this.addTextAttribute(e.desc,this.getToolProperty(n),o,function(e){return t.setToolProperty(n,e),t.getToolProperty(n)});break;case"number":this.addNumberAttribute(e.desc,this.getToolProperty(n),o,function(e){return t.setToolProperty(n,e),t.getToolProperty(n)});break;case"boolean":this.addToggleAttribute(e.desc,this.getToolProperty(n),o,function(e){return t.setToolProperty(n,e),t.getToolProperty(n)});break;case"color":this.addColorAttribute(e.desc,this.getToolProperty(n),o,function(e){return t.setToolProperty(n,e),t.getToolProperty(n)})}},e.prototype.getObjectProperty=function(e){if(this._object){var t=new h.WBGetPropertyEvent(e);return this._object.triggerEx(t),t.value}},e.prototype.setObjectProperty=function(e,t){this._object&&this._editor.executeCommand("SetObjectProperty",{objectName:this._object.entityName,propName:e,propValue:t})},e.prototype.addObjectProperty=function(e){var t=this,n=e.name,r=e.type,o=e.readonly;if(e.enum)this.addChoiceAttribute(e.desc,e.enum,this.getObjectProperty(n),o,function(e){switch(r){case"string":return t.setObjectProperty(n,e),t.getObjectProperty(n);case"number":return t.setObjectProperty(n,Number(e)),t.getObjectProperty(n);case"boolean":return t.setObjectProperty(n,Boolean(e)),t.getObjectProperty(n);case"color":return t.setObjectProperty(n,e),t.getObjectProperty(n)}});else switch(r){case"string":this.addTextAttribute(e.desc,this.getObjectProperty(n),o,function(e){return t.setObjectProperty(n,e),t.getObjectProperty(n)});break;case"number":this.addNumberAttribute(e.desc,this.getObjectProperty(n),o,function(e){return t.setObjectProperty(n,e),t.getObjectProperty(n)});break;case"boolean":this.addToggleAttribute(e.desc,this.getObjectProperty(n),o,function(e){return t.setObjectProperty(n,e),t.getObjectProperty(n)});break;case"color":this.addColorAttribute(e.desc,this.getObjectProperty(n),o,function(e){return t.setObjectProperty(n,e),t.getObjectProperty(n)})}},e.prototype.clear=function(){for(var e=document.querySelectorAll("table#"+this._tableId+" input"),t=0;t<e.length;t++)e[t].onchange=null;var n=document.querySelectorAll("table#"+this._tableId+" select");for(t=0;t<n.length;t++)n[t].onchange=null;for(var r=document.querySelector("table#"+this._tableId+" tbody");r&&r.hasChildNodes();)r.removeChild(r.firstChild);this._object=null},e.prototype.reloadToolProperties=function(){var e=this._object;this.clear(),e&&this.loadToolProperties(e)},e.prototype.loadToolProperties=function(e){var t=this;if(this._object!==e&&(this.clear(),this._object=e,this._object)){var n=new h.WBGetPropertyListEvent;if(this._object.triggerEx(n),n.properties)for(var r in n.properties){var o=n.properties[r];this.addGroup(o.desc),o.properties.forEach(function(e){t.addToolProperty(e)})}}},e.prototype.reloadObjectProperties=function(){var e=this._object;this.clear(),e&&this.loadObjectProperties(e)},e.prototype.loadObjectProperties=function(e){var t=this;if(this._object!==e&&(this.clear(),this._object=e,this._object)){var n=new h.WBGetPropertyListEvent;if(this._object.triggerEx(n),n.properties)for(var r in n.properties){var o=n.properties[r];this.addGroup(o.desc),o.properties.forEach(function(e){t.addObjectProperty(e)})}}},e.prototype.loadPageProperties=function(){var t=this;this.clear();var n=[],r=this._editor.whiteboard.view;r&&(r.forEachPage(function(e){n.push({value:e.name,desc:e.name})}),this.addChoiceAttribute("页面列表",n,r.currentPage,!1,function(e){return r.selectPage(e),t.loadPageProperties(),r.currentPage}),this.addTextAttribute("页面名称",r.currentPage,!1,function(e){if(e!==r.currentPage)return t._editor.executeCommand("RenamePage",{newName:e}),t.loadPageProperties(),r.currentPage},!0),this.addTextAttribute("页面背景图像",r.pageImage,!1,function(e){return r.pageImage=""===e?null:e,e},!0),this.addChoiceAttribute("页面背景重复",[{value:"repeat",desc:"重复"},{value:"repeat-x",desc:"横向重复"},{value:"repeat-y",desc:"纵向重复"},{value:"no-repeat",desc:"不重复"}],r.pageImageRepeat,!1,function(e){return r.pageImageRepeat=e}),this.addToggleAttribute("页面背景固定","fixed"===r.pageImageAttachment,!1,function(e){return r.pageImageAttachment=e?"fixed":"scroll",e}),this.addTextAttribute("页面背景大小",r.pageImageSize,!1,function(e){return r.pageImageSize=e}),this.addColorAttribute("页面背景颜色",r.pageColor||"",!1,function(e){return r.pageColor=""===e?null:e,e}),this.addButton("新建页面",function(){t._editor.executeCommand("AddPage"),t.loadPageProperties()}),this.addButton("删除页面",function(){t._editor.executeCommand("DeletePage"),t.loadPageProperties()}))},e.prototype.createRow=function(){var e=document.querySelector("#"+this._tableId+" tbody"),t=document.createElement("tr");return e&&t&&e.appendChild(t),t},e.prototype.createCell=function(e){var t=document.createElement("td");return t.style.color="#000",t.style.fontWeight="bold",t.style.overflow="hidden",t.style.whiteSpace="nowrap",t.style.textOverflow="ellipsis",t.style.height="24px",e.appendChild(t),t},e.prototype.createGroupCell=function(e,t){var n=this.createCell(e);return n.style.paddingLeft="5px",n.setAttribute("colspan","2"),n.innerText=t,n},e.prototype.createPropCell=function(e){var t=this.createCell(e);return t.style.paddingLeft="5px",t.style.border="dotted 1px #ccc",t.style.color="#000",t},e}();t.WBPropertyGrid=s;var n=function(){function e(e,t,n,r,o,i){this._strokeColor="#00000000",this._fillColor="red",this._toolFontSize=14,this._wb=e,this._toolset=t,this._toolPalette=new a(this,n),this._toolPalette.loadToolPalette(t.tools),this._opPalette=new a(this,r),this._opPalette.loadOpPalette(t.operations),this._objectPropGrid=new s(this,o,"wb-object"),this._toolPropGrid=new s(this,i,"wb-tool"),this._objectPropGrid.loadPageProperties()}return Object.defineProperty(e.prototype,"whiteboard",{get:function(){return this._wb},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"toolSet",{get:function(){return this._toolset},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"opPalette",{get:function(){return this._opPalette},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"toolPalette",{get:function(){return this._toolPalette},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"objectPropertyGrid",{get:function(){return this._objectPropGrid},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"toolPropertyGrid",{get:function(){return this._toolPropGrid},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"strokeColor",{get:function(){return this._strokeColor},set:function(e){this._strokeColor=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fillColor",{get:function(){return this._fillColor},set:function(e){this._fillColor=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"toolFontSize",{get:function(){return this._toolFontSize},set:function(e){this._toolFontSize=e},enumerable:!0,configurable:!0}),e.prototype.executeCommand=function(e,t){y.App.triggerEvent(null,new h.WBCommandEvent(e,t))},e}();t.WBEditor=n});t(c);c.WBToolPalette,c.WBPropertyGrid,c.WBEditor;var p=n(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.WBDefaultToolSet={tools:{CreateLabel:{iconClass:"fas fa-font fa-fw",command:"UseTool",args:{name:"Create",args:{createType:"Label",text:"标签",textColor:"#000000"}}},Select:{iconClass:"fas fa-mouse-pointer fa-fw",command:"UseTool",args:{name:"Select"}},Swap:{iconClass:"fas fa-exchange-alt fa-fw",command:"UseTool",args:{name:"Swap"}},Connect:{iconClass:"fas fa-arrow-right fa-fw",command:"UseTool",args:{name:"Connect"}},Write:{iconClass:"fas fa-pen fa-fw",command:"UseTool",args:{name:"HandWriting",args:{mode:"draw"}}},Erase:{iconClass:"fas fa-eraser fa-fw",command:"UseTool",args:{name:"HandWriting",args:{mode:"erase"}}}},operations:{Delete:{iconClass:"fas fa-trash-alt fa-fw",command:"DeleteSelected"},Clone:{iconClass:"fas fa-clone fa-fw",command:"CloneSelected"},AlignLeft:{iconClass:"fas fa-align-left fa-fw",command:"AlignSelected",args:{mode:"Left"}},AlignRight:{iconClass:"fas fa-align-right fa-fw",command:"AlignSelected",args:{mode:"Right"}},AlignTop:{iconClass:"fas fa-align-right fa-rotate-270 fa-fw",command:"AlignSelected",args:{mode:"Top"}},AlignBottom:{iconClass:"fas fa-align-right fa-rotate-90 fa-fw",command:"AlignSelected",args:{mode:"Bottom"}},ArrangeH:{iconClass:"fas fa-arrows-alt-h fa-fw",command:"ArrangeSelected",args:{mode:"Horizontal"}},ArrangeV:{iconClass:"fas fa-arrows-alt-v fa-fw",command:"ArrangeSelected",args:{mode:"Vertical"}}}}});t(p);p.WBDefaultToolSet;var f=n(function(e,n){function t(e){for(var t in e)n.hasOwnProperty(t)||(n[t]=e[t])}Object.defineProperty(n,"__esModule",{value:!0}),t(r),t(c),t(p)});t(f);var d=n(function(e,t){var r,n=Q&&Q.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var o=function(r){function e(e,t){void 0===t&&(t=null);var s=r.call(this,e||void 0)||this,n=t||{};return s._width=Number(n.width||0),s._height=Number(n.height||0),s._fontSize=Number(n.fontSize||16),s._fontStyle=n.fontStyle||"normal",s._fontVariant=n.fontVariant||"normal",s._fontWeight=n.fontWeight||"normal",s._fontFamily=n.fontFamily||"PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Source Han Sans CN,sans-serif",s._font="",s._text=n.text?s.parseText(n.text):"",s._measure=null,s._minwidth=10,s._textcolor=n.textColor||"#000",s._bkColor=n.bkColor||"#f00",s._bkShape=n.bkShape||"rect",s._boundingShape=null,s.anchorPoint={x:.5,y:.5},s.on(y.EvtUpdate.type,function(e){s.update()}),s.on(y.EvtGetBoundingShape.type,function(e){s._boundingShape&&(e.shape=s._boundingShape)}),s.on(y.EvtDraw.type,function(e){if(s._measure){var t=s._measure.width;t<s._minwidth&&(t=s._minwidth);var n=s._fontSize,r=Math.max(s._width,t),o=Math.max(s._height,n);switch(s._bkShape){case"rect":e.canvas.context.fillStyle=s._bkColor,e.canvas.context.fillRect(-r*s.anchorPoint.x,-o*s.anchorPoint.y,r,o);break;case"ellipse":e.canvas.context.fillStyle=s._bkColor,e.canvas.context.beginPath(),e.canvas.context.ellipse(-r*s.anchorPoint.x+r/2,-o*s.anchorPoint.y+o/2,r/2,o/2,0,0,2*Math.PI),e.canvas.context.closePath(),e.canvas.context.fill()}var i=(r-t)/2-r*s.anchorPoint.x,a=(o-n)/2-o*s.anchorPoint.y;e.canvas.context.fillStyle=s._textcolor,e.canvas.context.font=s._font,e.canvas.context.fillText(s._text,i,a,t)}}),s.on(h.WBGetPropertyEvent.type,function(e){switch(e.name){case"text":e.value=s.text;break;case"textColor":e.value=s._textcolor;break;case"fontSize":e.value=s.fontSize;break;case"fontWeight":e.value=s.fontWeight;break;case"fontStyle":e.value=s.fontStyle;break;case"width":e.value=s._width;break;case"height":e.value=s._height;break;case"bkColor":e.value=s.bkColor;break;case"bkShape":e.value=s.bkShape}}),s.on(h.WBSetPropertyEvent.type,function(e){switch(e.name){case"text":s.text=e.value;break;case"textColor":s._textcolor=e.value;break;case"fontSize":s.fontSize=Number(e.value);break;case"fontWeight":s.fontWeight=String(e.value);break;case"fontStyle":s.fontStyle=String(e.value);break;case"width":s.width=Number(e.value);break;case"height":s.height=Number(e.value);break;case"bkColor":s.bkColor=String(e.value);break;case"bkShape":s.bkShape=String(e.value)}}),s.on(h.WBGetPropertyListEvent.type,function(e){e.properties=e.properties||{},e.properties[s.entityType]=e.properties[s.entityType]||{desc:s.entityType,properties:[]},e.properties[s.entityType].properties.push({name:"text",desc:"文字内容",readonly:!1,type:"string",value:s.text}),e.properties[s.entityType].properties.push({name:"textColor",desc:"文字颜色",readonly:!1,type:"color",value:s._textcolor}),e.properties[s.entityType].properties.push({name:"fontSize",desc:"字体大小",readonly:!1,type:"number",value:s.fontSize}),e.properties[s.entityType].properties.push({name:"fontWeight",desc:"字体粗细",readonly:!1,type:"string",value:s._fontWeight,enum:[{value:"normal",desc:"正常"},{value:"bold",desc:"粗体"},{value:"bolder",desc:"加粗"},{value:"lighter",desc:"纤细"}]}),e.properties[s.entityType].properties.push({name:"fontStyle",desc:"字体样式",readonly:!1,type:"string",value:s._fontStyle,enum:[{value:"normal",desc:"正常"},{value:"italic",desc:"斜体"}]}),e.properties[s.entityType].properties.push({name:"width",desc:"宽度",readonly:!1,type:"number",value:s.width}),e.properties[s.entityType].properties.push({name:"height",desc:"高度",readonly:!1,type:"number",value:s.height}),e.properties[s.entityType].properties.push({name:"bkColor",desc:"背景颜色",readonly:!1,type:"color",value:s.bkColor}),e.properties[s.entityType].properties.push({name:"bkShape",desc:"背景样式",readonly:!1,type:"string",value:s.bkShape,enum:[{value:"none",desc:"无"},{value:"rect",desc:"矩形"},{value:"ellipse",desc:"圆形"}]})}),s}return n(e,r),Object.defineProperty(e.prototype,"text",{get:function(){return this._text},set:function(e){var t=this.parseText(e);t!==this._text&&(this._text=t,this._measure=null,this._boundingShape=null)},enumerable:!0,configurable:!0}),e.prototype.setAnchorPoint=function(e){r.prototype.setAnchorPoint.call(this,e),this._boundingShape=null},Object.defineProperty(e.prototype,"fontSize",{get:function(){return this._fontSize},set:function(e){e!==this._fontSize&&(this._fontSize=e,this._font="",this._measure=null,this._boundingShape=null)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fontWeight",{get:function(){return this._fontWeight},set:function(e){e!==this._fontWeight&&(this._fontWeight=e,this._font="",this._measure=null,this._boundingShape=null)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fontStyle",{get:function(){return this._fontStyle},set:function(e){e!==this._fontStyle&&(this._fontStyle=e,this._font="",this._measure=null,this._boundingShape=null)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this._width},set:function(e){e!==this._width&&(this._width=e,this._boundingShape=null)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this._height},set:function(e){e!==this._height&&(this._height=e,this._boundingShape=null)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bkColor",{get:function(){return this._bkColor},set:function(e){this._bkColor=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bkShape",{get:function(){return this._bkShape},set:function(e){this._bkShape=e},enumerable:!0,configurable:!0}),e.prototype.parseText=function(e){var t=/\{\{[^\{\}]*\}\}/g,n=e.split(t);if(1===n.length)return e;for(;;){var r=t.exec(e);if(null===r)break;var o=String(new Function("return "+r[0].slice(2,r[0].length-2))());n.splice(1,0,o)}return n.join("")},e.prototype.update=function(){if(""===this._font&&(this._font=this._fontStyle+" "+this._fontVariant+" "+this._fontWeight+" "+this._fontSize+"px "+this._fontFamily,this._boundingShape=null),this.view&&null===this._measure&&(this.view.canvas.context.textAlign="left",this.view.canvas.context.textBaseline="hanging",this.view.canvas.context.font=this._font,this._measure=this.view.canvas.context.measureText(this._text),this._boundingShape=null),this._measure&&!this._boundingShape){var e=Math.max(this._measure.width,this._minwidth),t=this._fontSize,n=Math.max(e,this._width),r=Math.max(t,this._height);this._boundingShape=new y.BoundingBox({x:-n*this.anchorPoint.x,y:-r*this.anchorPoint.y,w:n,h:r})}},e}(y.SceneObject);t.WBLabel=o;var i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t.prototype.getCreationProperties=function(){return[{name:"text",desc:"文字内容",readonly:!1,type:"string",value:"标签"},{name:"textColor",desc:"文字颜色",readonly:!1,type:"color",value:"#000"},{name:"fontSize",desc:"字体大小",readonly:!1,type:"number",value:16},{name:"fontWeight",desc:"字体粗细",readonly:!1,type:"string",value:"normal",enum:[{value:"normal",desc:"正常"},{value:"bold",desc:"粗体"},{value:"bolder",desc:"加粗"},{value:"lighter",desc:"纤细"}]},{name:"fontStyle",desc:"字体样式",readonly:!1,type:"string",value:"normal",enum:[{value:"normal",desc:"正常"},{value:"italic",desc:"斜体"}]},{name:"width",desc:"宽度",readonly:!1,type:"number",value:0},{name:"height",desc:"高度",readonly:!1,type:"number",value:0},{name:"bkColor",desc:"背景颜色",readonly:!1,type:"color",value:"#0000ff"},{name:"bkShape",desc:"背景样式",readonly:!1,type:"string",value:"none",enum:[{value:"none",desc:"无"},{value:"rect",desc:"矩形"},{value:"ellipse",desc:"圆形"}]}]},t.prototype._createEntity=function(e){return new o(null,e)},t}(h.WBFactory);t.WBLabelFactory=i});t(d);d.WBLabel,d.WBLabelFactory;var w=n(function(e,t){var r,n=Q&&Q.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var o=function(o){function e(e,t){void 0===t&&(t=null);var n=o.call(this,e||void 0)||this,r=t||{};return n._lineWidth=Number(r.lineWidth||1),n._arrowLen=Number(r.arrowLen||15),n._style=r.style||"single",n._color=r.color||"#000000",n._objectFrom=r.objectFrom||null,n._positionFrom={x:void 0===r.positionFromX?0:Number(r.positionFromX),y:void 0===r.positionFromY?0:Number(r.positionFromY)},n._objectTo=r.objectTo||null,n._positionTo={x:void 0===r.positionToX?0:Number(r.positionToX),y:void 0===r.positionToY?0:Number(r.positionToY)},n._segment=null,n._boundingShape=null,n.on(y.EvtUpdate.type,function(e){n.update()}),n.on(y.EvtGetBoundingShape.type,function(e){n._boundingShape||n.update(),n._boundingShape&&(e.shape=n._boundingShape)}),n.on(y.EvtDraw.type,function(e){if(n._segment)if("none"===n._style)e.canvas.context.strokeStyle=n._color,e.canvas.context.lineWidth=n._lineWidth,e.canvas.context.beginPath(),e.canvas.context.moveTo(n._segment.start.x,n._segment.start.y),e.canvas.context.lineTo(n._segment.end.x,n._segment.end.y),e.canvas.context.stroke();else{var t="double"===n._style;n.drawArrow(e.canvas.context,n._segment.end.x,n._segment.end.y,n._segment.start.x,n._segment.start.y,30,n._arrowLen,n._lineWidth,n._color,t)}}),n.on(h.WBGetPropertyEvent.type,function(e){switch(e.name){case"lineWidth":e.value=n._lineWidth;break;case"arrowLen":e.value=n._arrowLen;break;case"style":e.value=n._style;break;case"color":e.value=n._color;break;case"objectFrom":e.value=n._objectFrom||"";break;case"positionFromX":e.value=n._positionFrom?n._positionFrom.x:null;break;case"positionFromY":e.value=n._positionFrom?n._positionFrom.y:null;break;case"objectTo":e.value=n._objectTo||"";break;case"positionToX":e.value=n._positionTo?n._positionTo.x:null;break;case"positionToY":e.value=n._positionTo?n._positionTo.y:null}}),n.on(h.WBSetPropertyEvent.type,function(e){switch(e.name){case"lineWidth":n._lineWidth=Number(e.value);break;case"arrowLen":n._arrowLen=Number(e.value);break;case"style":n._style=String(e.value);break;case"color":n._color=String(e.value);break;case"objectFrom":n._objectFrom=""===e.value?null:String(e.value);break;case"positionFromX":n._positionFrom||(n._positionFrom={x:0,y:0}),n._positionFrom.x=Number(e.value);break;case"positionFromY":n._positionFrom||(n._positionFrom={x:0,y:0}),n._positionFrom.y=Number(e.value);break;case"objectTo":n._objectTo=""===e.value?null:String(e.value);break;case"positionToX":n._positionTo||(n._positionTo={x:0,y:0}),n._positionTo.x=Number(e.value);break;case"positionToY":n._positionTo||(n._positionTo={x:0,y:0}),n._positionTo.y=Number(e.value)}}),n.on(h.WBGetPropertyListEvent.type,function(e){e.properties=e.properties||{},e.properties[n.entityType]=e.properties[n.entityType]||{desc:n.entityType,properties:[]},e.properties[n.entityType].properties.push({name:"lineWidth",desc:"线宽",readonly:!1,type:"number",value:n._lineWidth}),e.properties[n.entityType].properties.push({name:"arrowLen",desc:"箭头长度",readonly:!1,type:"number",value:n._arrowLen}),e.properties[n.entityType].properties.push({name:"style",desc:"箭头样式",readonly:!1,type:"string",value:n._style,enum:[{value:"none",desc:"无"},{value:"single",desc:"单向箭头"},{value:"double",desc:"双向箭头"}]}),e.properties[n.entityType].properties.push({name:"color",desc:"颜色",readonly:!1,type:"color",value:n._color}),e.properties[n.entityType].properties.push({name:"objectFrom",desc:"绑定出发节点",readonly:!1,type:"string",value:n._objectFrom||""}),e.properties[n.entityType].properties.push({name:"positionFromX",desc:"出发点X坐标",readonly:!1,type:"number",value:n._positionFrom?n._positionFrom.x:null}),e.properties[n.entityType].properties.push({name:"positionFromY",desc:"出发点Y坐标",readonly:!1,type:"number",value:n._positionFrom?n._positionFrom.y:null}),e.properties[n.entityType].properties.push({name:"objectTo",desc:"绑定到达节点",readonly:!1,type:"string",value:n._objectTo||""}),e.properties[n.entityType].properties.push({name:"positionToX",desc:"到达点X坐标",readonly:!1,type:"number",value:n._positionTo?n._positionTo.x:null}),e.properties[n.entityType].properties.push({name:"positionToY",desc:"到达点Y坐标",readonly:!1,type:"number",value:n._positionTo?n._positionTo.y:null})}),n}return n(e,o),e.prototype.getSegment=function(){if(!this._positionFrom||!this._positionTo)return null;var e,t,n=this.worldTransform,r=n.transformPoint(this._positionFrom),o=n.transformPoint(this._positionTo),i={start:{x:r.x,y:r.y},end:{x:o.x,y:o.y}},a=null,s=null,c=null,l=null;if(this._objectFrom){var u=new h.WBGetObjectEvent(this._objectFrom);y.App.triggerEvent(null,u),(a=u.object||null)&&(s=a.worldTransform,i.start.x=s.e,i.start.y=s.f)}if(this._objectTo){u=new h.WBGetObjectEvent(this._objectTo);y.App.triggerEvent(null,u),(c=u.object||null)&&(l=c.worldTransform,i.end.x=l.e,i.end.y=l.f)}a&&s&&((t=(e=a.boundingShape)?y.IntersectionTestShapeSegment(e.getTransformedShape(s),i):null)&&0<t.length&&(i.start=t[0]));c&&l&&((t=(e=c.boundingShape)?y.IntersectionTestShapeSegment(e.getTransformedShape(l),i):null)&&0<t.length&&(i.end=t[0]));var p=y.Matrix2d.invert(n);return i.start=p.transformPoint(i.start),i.end=p.transformPoint(i.end),i},e.prototype.drawArrow=function(e,t,n,r,o,i,a,s,c,l){var u=180*Math.atan2(n-o,t-r)/Math.PI,p=(u+i)*Math.PI/180,h=(u-i)*Math.PI/180,f=a*Math.cos(p),d=a*Math.sin(p),y=a*Math.cos(h),v=a*Math.sin(h);e.beginPath();var g=t-f,m=n-d;e.moveTo(g,m),e.lineTo(t,n),g=t-y,m=n-v,e.lineTo(g,m),e.moveTo(t,n),e.lineTo(r,o),l&&(g=r+f,m=o+d,e.moveTo(g,m),e.lineTo(r,o),g=r+y,m=o+v,e.lineTo(g,m)),e.strokeStyle=c,e.lineWidth=s,e.stroke()},e.prototype.update=function(){if(this._segment=this.getSegment(),this._segment){var e=y.GetVector(this._segment.start,this._segment.end),t=y.VectorLength(e),n=Math.floor(this._lineWidth/2+3),r=n*e.y/t,o=-n*e.x/t;null===this._boundingShape?this._boundingShape=new y.BoundingHull:this._boundingShape.clear(),this._boundingShape.addPoint({x:this._segment.start.x+r,y:this._segment.start.y+o}),this._boundingShape.addPoint({x:this._segment.start.x-r,y:this._segment.start.y-o}),this._boundingShape.addPoint({x:this._segment.end.x-r,y:this._segment.end.y-o}),this._boundingShape.addPoint({x:this._segment.end.x+r,y:this._segment.end.y+o})}},e}(y.SceneObject);t.WBArrow=o;var i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t.prototype.getCreationProperties=function(){return[{name:"lineWidth",desc:"线宽",readonly:!1,type:"number",value:3},{name:"arrowLen",desc:"箭头长度",readonly:!1,type:"number",value:15},{name:"style",desc:"箭头样式",readonly:!1,type:"string",value:"single",enum:[{value:"none",desc:"无"},{value:"single",desc:"单向箭头"},{value:"double",desc:"双向箭头"}]},{name:"color",desc:"颜色",readonly:!1,type:"color",value:"#000000"}]},t.prototype._createEntity=function(e){return new o(null,e)},t}(h.WBFactory);t.WBArrowFactory=i});t(w);w.WBArrow,w.WBArrowFactory;var P=n(function(e,t){var r,n=Q&&Q.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var o=function(r){function e(e,t){void 0===t&&(t=null);var o=r.call(this,e||void 0)||this;o._canvas=null,o._boundingShape=null,o._cp=[],o._lastMoveTime=0,o._action=!1;var n=t||{};return o._lineWidth=Number(n.lineWidth||1),o._color=n.color||"#000000",o._mode=n.mode||"draw",o._mousePosX=0,o._mousePosY=0,o._eraseSize=n.eraseSize||20,o._curveMode=n.curveMode||0,o.on(y.EvtCanvasResize.type,function(e){e.view===o.view&&o._canvas&&(o._canvas.width=e.view.canvas.width,o._canvas.height=e.view.canvas.height,o._boundingShape&&(o._boundingShape.rect={x:0,y:0,w:o._canvas.width,h:o._canvas.height}))}),o.on(y.EvtGetBoundingShape.type,function(e){null===o._boundingShape&&o.canvas&&(o._boundingShape=new y.BoundingBox({x:0,y:0,w:o.canvas.width,h:o.canvas.height})),o._boundingShape&&(e.shape=o._boundingShape)}),o.on(y.EvtHitTest.type,function(e){var t=o.canvas;if(t&&0<=e.x&&e.x<t.width&&0<=e.y&&e.y<t.height){var n=t.getContext("2d");if(n){var r=n.getImageData(e.x,e.y,1,1);r&&0<r.data[3]&&(e.result=!0)}}e.eat()}),o.on(y.EvtDraw.type,function(e){if(o.canvas){var t=o.canvas.width,n=o.canvas.height;e.canvas.context.drawImage(o.canvas,-Math.round(t*o.anchorPoint.x)-.5,-Math.round(n*o.anchorPoint.y)-.5,t,n),"erase"===o._mode&&(e.canvas.context.strokeStyle="#000000",e.canvas.context.strokeRect(Math.round(o._mousePosX-o._eraseSize/2),Math.round(o._mousePosY-o._eraseSize/2),o._eraseSize,o._eraseSize))}}),o.on(y.EvtMouseDown.type,function(e){var t=y.Matrix2d.invert(o.worldTransform).transformPoint({x:e.x,y:e.y});if(o.canvas)if("draw"===o._mode)(n=o.canvas.getContext("2d"))&&(n.lineWidth=o._lineWidth,n.strokeStyle=o._color,n.lineCap="round",n.lineJoin="round",n.beginPath(),n.moveTo(t.x+.5,t.y+.5),o._cp.length=0,o._action=!0);else if("erase"===o._mode){var n;(n=o.canvas.getContext("2d"))&&(n.clearRect(t.x-o._eraseSize/2,t.y-o._eraseSize/2,o._eraseSize,o._eraseSize),o._action=!0)}}),o.on(y.EvtMouseMove.type,function(e){if(o._mousePosX=e.x,o._mousePosY=e.y,o._action&&o.canvas){var t=y.Matrix2d.invert(o.worldTransform).transformPoint({x:e.x,y:e.y});if("draw"===o._mode)(n=o.canvas.getContext("2d"))&&(0===o._curveMode?(n.lineTo(t.x+.5,t.y+.5),n.stroke()):1===o._curveMode?1===o._cp.length?(n.quadraticCurveTo(o._cp[0].x+.5,o._cp[0].y+.5,t.x+.5,t.y+.5),n.stroke(),o._cp.length=0):(o._cp.push({x:t.x,y:t.y}),o._lastMoveTime=Date.now()):2===o._curveMode&&(2===o._cp.length?(n.bezierCurveTo(o._cp[0].x+.5,o._cp[0].y+.5,o._cp[1].x+.5,o._cp[1].y+.5,t.x+.5,t.y+.5),n.stroke(),o._cp.length=0):(o._cp.push({x:t.x,y:t.y}),o._lastMoveTime=Date.now())));else if("erase"===o._mode){var n;(n=o.canvas.getContext("2d"))&&n.clearRect(t.x-o._eraseSize/2,t.y-o._eraseSize/2,o._eraseSize,o._eraseSize)}}}),o.on(y.EvtFrame.type,function(e){"draw"===o._mode&&o._action&&(Date.now()>o._lastMoveTime+250&&o.finishDraw())}),o.on(y.EvtMouseUp.type,function(e){"draw"===o._mode&&o._action&&o.finishDraw(),o._action=!1}),o.on(h.WBGetPropertyEvent.type,function(e){switch(e.name){case"lineWidth":e.value=o._lineWidth;break;case"color":e.value=o._color;break;case"curveMode":e.value=o._curveMode;break;case"eraseSize":e.value=o._eraseSize}}),o.on(h.WBSetPropertyEvent.type,function(e){switch(e.name){case"lineWidth":o._lineWidth=Number(e.value);break;case"color":o._color=String(e.value);break;case"curveMode":o._curveMode=Number(e.value);break;case"eraseSize":o._eraseSize=Number(e.value)}}),o.on(h.WBGetPropertyListEvent.type,function(e){e.properties=e.properties||{},e.properties[o.entityType]=e.properties[o.entityType]||{desc:o.entityType,properties:[]},e.properties[o.entityType].properties.push({name:"lineWidth",desc:"画笔宽度",readonly:!1,type:"number",value:o._lineWidth}),e.properties[o.entityType].properties.push({name:"color",desc:"画笔颜色",readonly:!1,type:"color",value:o._color}),e.properties[o.entityType].properties.push({name:"curveMode",desc:"平滑模式",readonly:!1,type:"number",value:o._curveMode,enum:[{value:0,desc:"无"},{value:1,desc:"二次样条"},{value:2,desc:"三次样条"}]}),e.properties[o.entityType].properties.push({name:"eraseSize",desc:"橡皮宽度",readonly:!1,type:"number",value:o._eraseSize})}),o}return n(e,r),Object.defineProperty(e.prototype,"mode",{get:function(){return this._mode},set:function(e){this._mode!==e&&("draw"===this._mode&&this.finishDraw(),this._action=!1,this._mode=e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"canvas",{get:function(){return null===this._canvas&&this.view&&(this._canvas=document.createElement("canvas"),this._canvas.style.backgroundColor="#00000000",this._canvas.width=this.view.canvas.width,this._canvas.height=this.view.canvas.height,this._boundingShape&&(this._boundingShape=new y.BoundingBox({x:0,y:0,w:this._canvas.width,h:this._canvas.height}))),this._canvas},enumerable:!0,configurable:!0}),e.prototype.finishDraw=function(){if(this.canvas&&"draw"===this._mode&&0<this._cp.length){var e=this.canvas.getContext("2d");e&&(1===this._cp.length?e.lineTo(this._cp[0].x+.5,this._cp[0].y+.5):this._cp.length&&e.quadraticCurveTo(this._cp[0].x+.5,this._cp[0].y+.5,this._cp[1].x+.5,this._cp[1].y+.5),e.stroke(),this._cp.length=0)}},e}(y.SceneObject);t.WBFreeDraw=o;var i=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t.prototype.getCreationProperties=function(){return[{name:"lineWidth",desc:"画笔宽度",readonly:!1,type:"number",value:3},{name:"color",desc:"颜色",readonly:!1,type:"color",value:"#000000"},{name:"curveMode",desc:"平滑模式",readonly:!1,type:"number",value:0,enum:[{value:0,desc:"无"},{value:1,desc:"二次样条"},{value:2,desc:"三次样条"}]},{name:"eraseSize",desc:"橡皮宽度",readonly:!1,type:"number",value:20}]},t.prototype._createEntity=function(e){return new o(null,e)},t}(h.WBFactory);t.WBFreeDrawFactory=i});t(P);P.WBFreeDraw,P.WBFreeDrawFactory;var x=n(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.installFactories=function(e){e.addFactory(new d.WBLabelFactory("Label")),e.addFactory(new w.WBArrowFactory("Arrow")),e.addFactory(new P.WBFreeDrawFactory("FreeDraw"))}});t(x);x.installFactories;var T=n(function(e,n){function t(e){for(var t in e)n.hasOwnProperty(t)||(n[t]=e[t])}Object.defineProperty(n,"__esModule",{value:!0}),t(d),t(w),t(P),t(x)});t(T);var j=n(function(e,t){var r,i=Q&&Q.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var o=function(n){function r(e){var t=n.call(this,r.type)||this;return t.selectIndex=e,t}return i(r,n),r.type="@WBSelect",r}(y.BaseEvent);t.WBSelectEvent=o;var a=function(e){function t(){return e.call(this,t.type)||this}return i(t,e),t.type="@WBDeselect",t}(y.BaseEvent);t.WBDeselectEvent=a;var s=function(n){function r(e){var t=n.call(this,r.type)||this;return t.objects=e,t}return i(r,n),r.type="@WBObjectSelected",r}(y.BaseEvent);t.WBObjectSelectedEvent=s;var c=function(n){function r(e){var t=n.call(this,r.type)||this;return t.objects=e,t}return i(r,n),r.type="@WBObjectMoved",r}(y.BaseEvent);t.WBObjectMovedEvent=c;var l=function(r){function o(e,t){var n=r.call(this,o.type)||this;return n.object=e,n.objects=t,n}return i(o,r),o.type="@WBObjectDeselected",o}(y.BaseEvent);t.WBObjectDeselectedEvent=l;var u=function(t){function n(e){var r=t.call(this,n.type)||this;return r.tool=e,r._selected=!1,r.on(y.EvtDraw.type,function(e){if(r._selected){var t=r.object.boundingShape;if(t){var n=t.getBoundingbox();n&&(e.canvas.context.strokeStyle="#000",e.canvas.context.lineWidth=1,e.canvas.context.strokeRect(n.x,n.y,n.w,n.h))}}}),r.on(o.type,function(e){r._selected=!0}),r.on(a.type,function(e){r._selected=!1}),r}return i(n,t),n.type="WBSelect",n}(y.Component);t.WBSelectComponent=u;var n=function(n){function r(e){var t=n.call(this,r.toolname,e)||this;return t._selectedObjects=[],t._moving=!1,t._rangeSelecting=!1,t._mouseStartPosX=0,t._mouseStartPosY=0,t._mouseCurrentPosX=0,t._mouseCurrentPosY=0,t}return i(r,n),Object.defineProperty(r.prototype,"selectedObjects",{get:function(){return this._selectedObjects},enumerable:!0,configurable:!0}),r.prototype.activate=function(e){var o=this;n.prototype.activate.call(this,e),this._selectedObjects.length=0,this.on(y.EvtKeyDown.type,function(e){1===o._selectedObjects.length&&o._selectedObjects[0].triggerEx(e)}),this.on(y.EvtKeyUp.type,function(e){1===o._selectedObjects.length&&o._selectedObjects[0].triggerEx(e)}),this.on(y.EvtKeyPress.type,function(e){1===o._selectedObjects.length&&o._selectedObjects[0].triggerEx(e)}),this.on(y.EvtMouseDown.type,function(e){o._mouseStartPosX=e.x,o._mouseStartPosY=e.y;var t=o._wb.view;if(t){var n=t.hitObjects;1<n.length?(o.selectObject(n[0],e),o._moving=!0,o._rangeSelecting=!1):(o.deselectAll(),o._rangeSelecting=!0,o._moving=!1,o._mouseCurrentPosX=e.x,o._mouseCurrentPosY=e.y)}}),this.on(y.EvtMouseMove.type,function(e){if(o._moving){var n=e.x-o._mouseStartPosX,r=e.y-o._mouseStartPosY;o._mouseStartPosX=e.x,o._mouseStartPosY=e.y,o._selectedObjects.forEach(function(e){var t=e.translation;e.translation={x:t.x+n,y:t.y+r}})}else if(o._rangeSelecting){var t=o._wb.view;t&&t.rootNode&&(o.rangeSelectR(t.rootNode,o._mouseStartPosX,o._mouseStartPosY,e.x-o._mouseStartPosX,e.y-o._mouseStartPosY),o._mouseCurrentPosX=e.x,o._mouseCurrentPosY=e.y)}}),this.on(y.EvtMouseUp.type,function(e){o._moving&&o._selectedObjects&&0<o._selectedObjects.length&&y.App.triggerEvent(null,new c(o._selectedObjects)),o._moving=!1,o._rangeSelecting=!1}),this.on(y.EvtDraw.type,function(e){o._rangeSelecting&&(e.canvas.context.save(),e.canvas.context.setTransform(1,0,0,1,.5,.5),e.canvas.context.strokeStyle="#000",e.canvas.context.lineWidth=1,e.canvas.context.setLineDash([6,3]),e.canvas.context.beginPath(),e.canvas.context.moveTo(o._mouseStartPosX,o._mouseStartPosY),e.canvas.context.lineTo(o._mouseCurrentPosX,o._mouseStartPosY),e.canvas.context.lineTo(o._mouseCurrentPosX,o._mouseCurrentPosY),e.canvas.context.moveTo(o._mouseStartPosX,o._mouseStartPosY),e.canvas.context.lineTo(o._mouseStartPosX,o._mouseCurrentPosY),e.canvas.context.lineTo(o._mouseCurrentPosX,o._mouseCurrentPosY),e.canvas.context.stroke(),e.canvas.context.restore())})},r.prototype.deactivate=function(){this.off(y.EvtKeyDown.type),this.off(y.EvtKeyUp.type),this.off(y.EvtKeyPress.type),this.off(y.EvtMouseDown.type),this.off(y.EvtMouseMove.type),this.off(y.EvtMouseUp.type),this.off(y.EvtDraw.type),n.prototype.deactivate.call(this)},r.prototype.activateObject=function(e){this.deactivateObject(e),e.addComponent(new u(this))},r.prototype.deactivateObject=function(e){var t=e.getComponents(u.type);t&&0<t.length&&(this.deselectObject(e),e.removeComponentsByType(u.type))},r.prototype.executeCommand=function(e,t){if("GetSelected"===e)t.selectedObjects=this._selectedObjects;else if("DeleteSelected"===e)0<this._selectedObjects.length&&y.App.triggerEvent(null,new h.WBCommandEvent("DeleteObjects",{objects:this._selectedObjects.map(function(e){return e.entityName})}));else if("AlignSelected"===e){var n=t.mode;0<this._selectedObjects.length&&y.App.triggerEvent(null,new h.WBCommandEvent("AlignObjects"+n,{objects:this._selectedObjects.map(function(e){return e.entityName})}))}else if("ArrangeSelected"===e){n=t.mode;0<this._selectedObjects.length&&y.App.triggerEvent(null,new h.WBCommandEvent("ArrangeObjects"+n,{objects:this._selectedObjects.map(function(e){return e.entityName})}))}},r.prototype.selectObject=function(e,t){this._selectedObjects.indexOf(e)<0&&(!t||(y.EvtSysInfo.isMac()?t.metaDown:t.ctrlDown)||this.deselectAll(),this.selectedObjects.push(e),e.triggerEx(new o(this.selectedObjects.length)),y.App.triggerEvent(null,new s(this._selectedObjects)))},r.prototype.deselectObject=function(e){var t=this._selectedObjects.indexOf(e);0<=t&&(e.triggerEx(new a),this.selectedObjects.splice(t,1),y.App.triggerEvent(null,new l(e,this._selectedObjects)))},r.prototype.deselectAll=function(){for(;0<this.selectedObjects.length;)this.deselectObject(this.selectedObjects[this.selectedObjects.length-1])},r.prototype.rangeSelectR=function(e,o,i,a,s){var c=this;e.forEachChild(function(e){if(0===a||0===s)c.deselectObject(e);else{var t=e.boundingShape;if(t){var n=y.Matrix2d.invert(e.worldTransform),r=[n.transformPoint({x:o,y:i}),n.transformPoint({x:o,y:i+s}),n.transformPoint({x:o+a,y:i+s}),n.transformPoint({x:o+a,y:i})];y.IntersectionTestShapeHull(t,r)?c.selectObject(e,null):c.deselectObject(e)}c.rangeSelectR(e,o,i,a,s)}})},r.toolname="Select",r}(h.WBTool);t.WBSelectTool=n});t(j);j.WBSelectEvent,j.WBDeselectEvent,j.WBObjectSelectedEvent,j.WBObjectMovedEvent,j.WBObjectDeselectedEvent,j.WBSelectComponent,j.WBSelectTool;var k=n(function(e,t){var r,o=Q&&Q.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var i=function(t){function n(e){var r=t.call(this,n.type)||this;return r.tool=e,r.selected=!1,r.on(y.EvtMouseDown.type,function(e){r.tool.currentObject?r.tool.currentObject.getComponent(n.type,0).selected=!1:r.selected=!0,r.tool.selectObject(r.object,e)}),r.on(y.EvtDraw.type,function(e){if(r.selected){var t=r.object.boundingShape;if(t){var n=t.getBoundingbox();n&&(e.canvas.context.strokeStyle="#000",e.canvas.context.lineWidth=1,e.canvas.context.strokeRect(n.x,n.y,n.w,n.h))}}}),r}return o(n,t),n.type="WBSwap",n}(y.Component);t.WBSwapComponent=i;var n=function(n){function r(e){var t=n.call(this,r.toolname,e)||this;return t._curObject=null,t}return o(r,n),Object.defineProperty(r.prototype,"currentObject",{get:function(){return this._curObject},enumerable:!0,configurable:!0}),r.prototype.activate=function(e){n.prototype.activate.call(this,e),this._curObject=null},r.prototype.deactivate=function(){this._curObject&&(this._curObject.triggerEx(new j.WBDeselectEvent),this._curObject=null),n.prototype.deactivate.call(this)},r.prototype.activateObject=function(e){this.deactivateObject(e),e.addComponent(new i(this))},r.prototype.deactivateObject=function(e){e.removeComponentsByType(i.type)},r.prototype.selectObject=function(e,t){null==this._curObject?this._curObject=e:(this._curObject!==e&&this.swapObject(this._curObject,e,200),this._curObject=null)},r.prototype.swapObject=function(e,t,n){var r=e.translation,o=t.translation;(t.getComponents(y.CoKeyframeAnimation.type)||[]).forEach(function(e){e.finish(),t.removeComponentsByType(y.CoKeyframeAnimation.type)}),t.addComponent(new y.CoKeyframeAnimation({delay:0,repeat:1,exclusive:!0,tracks:{translation:{cp:[{x:0,y:[o.x,o.y]},{x:n,y:[r.x,r.y]}],type:y.SplineType.LINEAR}}})),e.addComponent(new y.CoKeyframeAnimation({delay:0,repeat:1,exclusive:!0,tracks:{translation:{cp:[{x:0,y:[r.x,r.y]},{x:n,y:[o.x,o.y]}],type:y.SplineType.LINEAR}}}))},r.toolname="Swap",r}(h.WBTool);t.WBSwapTool=n});t(k);k.WBSwapComponent,k.WBSwapTool;var S=n(function(e,t){var r,o=Q&&Q.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var n=function(n){function r(e){var t=n.call(this,r.toolname,e)||this;return t.options={},t._factoryProperties=[],t._creationParams={},t}return o(r,n),r.prototype.activate=function(t){var r=this;t&&(this.options=t,void 0===this._creationParams[t.createType]&&(this._creationParams[t.createType]={},this._factoryProperties=this._wb.getFactory(t.createType).getCreationProperties(),this._factoryProperties&&this._factoryProperties.forEach(function(e){r._creationParams[t.createType][e.name]=e.value}))),this.on(y.EvtMouseDown.type,function(e){var t={type:r.options.createType,name:null};for(var n in r.options)"command"!==n&&"createType"!==n&&"type"!==n&&(t[n]=r.options[n]);t.x=e.x,t.y=e.y,t.params=r._creationParams[r.options.createType],y.App.triggerEvent(null,new h.WBCommandEvent("CreateObject",t))}),this.on(h.WBGetPropertyEvent.type,function(e){e.name in r._creationParams[r.options.createType]&&(e.value=r._creationParams[r.options.createType][e.name])}),this.on(h.WBSetPropertyEvent.type,function(e){e.name in r._creationParams[r.options.createType]&&(r._creationParams[r.options.createType][e.name]=e.value)}),this.on(h.WBGetPropertyListEvent.type,function(e){r._factoryProperties&&0<r._factoryProperties.length&&(e.properties=e.properties||{},e.properties[r.options.createType]=e.properties[r.options.createType]||{desc:r.options.createType,properties:[]},e.properties[r.options.createType].properties=r._factoryProperties)}),n.prototype.activate.call(this,t)},r.prototype.deactivate=function(){this.off(y.EvtMouseDown.type),this.options={},n.prototype.deactivate.call(this)},r.toolname="Create",r}(h.WBTool);t.WBCreateTool=n});t(S);S.WBCreateTool;var E=n(function(e,t){var r,o=Q&&Q.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var n=function(n){function r(e){var t=n.call(this,r.toolname,e)||this;return t._createParams={lineWidth:3,arrowLen:15,style:"single",color:"#000000",objectFrom:null,positionFromX:0,positionFromY:0,objectTo:null,positionToX:0,positionToY:0},t._moving=!1,t.on(h.WBGetPropertyEvent.type,function(e){e.name in t._createParams&&(e.value=t._createParams[e.name])}),t.on(h.WBSetPropertyEvent.type,function(e){e.name in t._createParams&&(t._createParams[e.name]=e.value)}),t.on(h.WBGetPropertyListEvent.type,function(e){e.properties=e.properties||{},e.properties[t.name]=e.properties[t.name]||{desc:"画笔工具",properties:[]},e.properties[t.name].properties.push({name:"lineWidth",desc:"线宽",readonly:!1,type:"number",value:t._createParams.lineWidth}),e.properties[t.name].properties.push({name:"arrowLen",desc:"箭头长度",readonly:!1,type:"number",value:t._createParams.arrowLen}),e.properties[t.name].properties.push({name:"style",desc:"箭头样式",readonly:!1,type:"string",value:t._createParams.style,enum:[{value:"none",desc:"无"},{value:"single",desc:"单向箭头"},{value:"double",desc:"双向箭头"}]}),e.properties[t.name].properties.push({name:"color",desc:"颜色",readonly:!1,type:"color",value:t._createParams.color})}),t}return o(r,n),r.prototype.activate=function(e){var r=this;n.prototype.activate.call(this,e),this._moving=!1,this.on(y.EvtMouseDown.type,function(e){var t=r._wb.view;if(t){r._moving=!0,r._createParams.objectFrom=null,r._createParams.objectTo=null,r._createParams.positionToX=e.x,r._createParams.positionToY=e.y;var n=t.hitObjects;1<n.length&&"Arrow"!==n[0].entityType?r._createParams.objectFrom=n[0]:(r._createParams.positionFromX=e.x,r._createParams.positionFromY=e.y)}}),this.on(y.EvtMouseMove.type,function(e){if(r._moving){var t=r._wb.view;if(t){var n=t.hitObjects;1<n.length&&n[0]!==r._createParams.objectFrom&&"Arrow"!==n[0].entityType?r._createParams.objectTo=n[0]:(r._createParams.objectTo=null,r._createParams.positionToX=e.x,r._createParams.positionToY=e.y)}}}),this.on(y.EvtMouseUp.type,function(e){r._moving=!1;var t=0,n=0;r._createParams.objectFrom&&r._createParams.objectTo?(r._createParams.objectFrom=r._createParams.objectFrom.entityName,r._createParams.objectTo=r._createParams.objectTo.entityName):r._createParams.objectFrom?(r._createParams.objectFrom=r._createParams.objectFrom.entityName,t=r._createParams.positionToX,n=r._createParams.positionToY,r._createParams.positionToX=0,r._createParams.positionToY=0):(r._createParams.objectTo?(r._createParams.objectTo=r._createParams.objectTo.entityName,t=r._createParams.positionFromX,n=r._createParams.positionFromY):(t=r._createParams.positionFromX,n=r._createParams.positionFromY,r._createParams.positionToX-=t,r._createParams.positionToY-=n),r._createParams.positionFromX=0,r._createParams.positionFromY=0),y.App.triggerEvent(null,new h.WBCommandEvent("CreateObject",{type:"Arrow",name:null,x:t,y:n,params:r._createParams}))}),this.on(y.EvtDraw.type,function(e){if(r._moving){if(e.canvas.context.save(),e.canvas.context.setTransform(1,0,0,1,.5,.5),e.canvas.context.strokeStyle="#000",e.canvas.context.lineWidth=1,e.canvas.context.setLineDash([6,3]),e.canvas.context.beginPath(),r._createParams.objectFrom){var t=r._createParams.objectFrom.worldTransform;e.canvas.context.moveTo(t.e,t.f)}else e.canvas.context.moveTo(r._createParams.positionFromX,r._createParams.positionFromY);if(r._createParams.objectTo){t=r._createParams.objectTo.worldTransform;e.canvas.context.lineTo(t.e,t.f)}else e.canvas.context.lineTo(r._createParams.positionToX,r._createParams.positionToY);e.canvas.context.stroke(),e.canvas.context.restore()}})},r.prototype.deactivate=function(){this.off(y.EvtMouseDown.type),this.off(y.EvtMouseMove.type),this.off(y.EvtMouseUp.type),n.prototype.deactivate.call(this)},r.prototype.activateObject=function(e){n.prototype.activateObject.call(this,e)},r.prototype.deactivateObject=function(e){n.prototype.deactivateObject.call(this,e)},r.toolname="Connect",r}(h.WBTool);t.WBConnectTool=n});t(E);E.WBConnectTool;var O=n(function(e,t){var r,n=Q&&Q.__extends||(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(t,"__esModule",{value:!0});var o=function(r){function t(e){var n=r.call(this,t.toolname,e)||this;return n._freedrawNode=null,n._mode="draw",n._paramsDraw={color:"#000",lineWidth:2,curveMode:0},n._paramsErase={eraseSize:20},n.on(h.WBGetPropertyEvent.type,function(e){var t=null;"draw"===n._mode?t=n._paramsDraw:"erase"===n._mode&&(t=n._paramsErase),t&&e.name in t&&(e.value=t[e.name])}),n.on(h.WBSetPropertyEvent.type,function(e){var t=null;"draw"===n._mode?t=n._paramsDraw:"erase"===n._mode&&(t=n._paramsErase),t&&e.name in t&&(t[e.name]=e.value,n.applyProperty(e.name,e.value))}),n.on(h.WBGetPropertyListEvent.type,function(e){e.properties=e.properties||{},"draw"===n._mode?(e.properties[n.name]=e.properties[n.name]||{desc:"画笔工具",properties:[]},e.properties[n.name].properties.push({name:"color",desc:"画笔颜色",readonly:!1,type:"color",value:n._paramsDraw.color}),e.properties[n.name].properties.push({name:"lineWidth",desc:"画笔粗细",readonly:!1,type:"number",value:n._paramsDraw.lineWidth}),e.properties[n.name].properties.push({name:"curveMode",desc:"平滑模式",readonly:!1,type:"number",value:n._paramsDraw.curveMode,enum:[{value:0,desc:"无"},{value:1,desc:"二次样条"},{value:2,desc:"三次样条"}]})):"erase"===n._mode&&(e.properties[n.name]=e.properties[n.name]||{desc:"橡皮工具",properties:[]},e.properties[n.name].properties.push({name:"eraseSize",desc:"橡皮大小",readonly:!1,type:"number",value:n._paramsErase.eraseSize}))}),n}return n(t,r),t.prototype.activate=function(e){if(e&&(this._mode=e.mode||"draw"),this._freedrawNode=this.findFreedrawNode(),!this._freedrawNode){var t={};y.App.triggerEvent(null,new h.WBCommandEvent("CreateObject",{type:"FreeDraw",name:null,x:0,y:0},t)),this._freedrawNode=t.objectCreated}this._freedrawNode&&(this._freedrawNode.mode=this._mode,this._freedrawNode.setCapture(),this.applyProperties(this._paramsDraw),this.applyProperties(this._paramsErase),r.prototype.activate.call(this,e))},t.prototype.deactivate=function(){this._freedrawNode&&(this._freedrawNode.releaseCapture(),this._freedrawNode.mode="none",this._freedrawNode=null),r.prototype.deactivate.call(this)},t.prototype.activateObject=function(e){r.prototype.activateObject.call(this,e)},t.prototype.deactivateObject=function(e){r.prototype.deactivateObject.call(this,e)},t.prototype.applyProperty=function(e,t){this._freedrawNode&&this._freedrawNode.triggerEx(new h.WBSetPropertyEvent(e,t))},t.prototype.applyProperties=function(e){for(var t in e)this.applyProperty(t,e[t])},t.prototype.findFreedrawNode=function(e){var t=this._wb.view;if(t){var n=e||t.rootNode;if(n){if("FreeDraw"===n.entityType)return n;for(var r=0;r<n.numChildren;r++){var o=this.findFreedrawNode(n.childAt(r));if(o)return o}}}return null},t.toolname="HandWriting",t}(h.WBTool);t.WBHandWritingTool=o});t(O);O.WBHandWritingTool;var C=n(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.installTools=function(e){e.addTool(new j.WBSelectTool(e)),e.addTool(new k.WBSwapTool(e)),e.addTool(new S.WBCreateTool(e)),e.addTool(new E.WBConnectTool(e)),e.addTool(new O.WBHandWritingTool(e))}});t(C);C.installTools;var B=n(function(e,n){function t(e){for(var t in e)n.hasOwnProperty(t)||(n[t]=e[t])}Object.defineProperty(n,"__esModule",{value:!0}),t(j),t(k),t(S),t(E),t(O),t(C)});t(B);var W=n(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function i(){}return i.parse=function(e){var t={command:""},n={str:i.trimLeft(e),token:""};for(i.lexical(n),t.command=n.token;i.lexical(n),""!==n.token;){var r=n.token.split("=");if(1===r.length)t[r[0]]=!0;else{var o=r[1];1<o.length&&"["===o.charAt(0)&&"]"===o.charAt(o.length-1)&&(o=o.substr(1,o.length-2).split(",")),t[r[0]]=o}}return t},i.trimLeft=function(e){for(var t=0;t<e.length&&0<=" \n\r\t\f\v            ​\u2028\u2029　".indexOf(e.charAt(t));)t++;return e.substring(t,e.length-t)},i.trimRight=function(e){for(var t=e.length-1;0<=t&&0<=" \n\r\t\f\v            ​\u2028\u2029　".indexOf(e.charAt(t));)t--;return e.substring(0,t+1)},i.trim=function(e){return this.trimRight(this.trimLeft(e))},i.lexical=function(e){for(var t=" \n\r\t\f\v            ​\u2028\u2029　",n=0;n<e.str.length&&0<=t.indexOf(e.str.charAt(n));)n++;for(e.str=e.str.substr(n,e.str.length-n),n=0;n<e.str.length&&t.indexOf(e.str.charAt(n))<0;)n++;e.token=e.str.substr(0,n),e.str=e.str.substr(n,e.str.length-n)},i}();t.WBCommandParser=n});t(W);W.WBCommandParser;var M=n(function(e,n){function t(e){for(var t in e)n.hasOwnProperty(t)||(n[t]=e[t])}Object.defineProperty(n,"__esModule",{value:!0}),t(f),t(T),t(B),t(W),t(h)});t(M);var A=n(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.init=function(){var e=new M.WhiteBoard(document.querySelector("#playground-canvas"),!0);M.installTools(e),M.installFactories(e);var t=document.querySelector("#tool-toolbox"),n=document.querySelector("#op-toolbox"),r=document.querySelector("#object-propgrid"),o=document.querySelector("#tool-propgrid"),i=new M.WBEditor(e,M.WBDefaultToolSet,t,n,r,o);e.on(M.WBObjectSelectedEvent.type,function(e){1===e.objects.length?i.objectPropertyGrid.loadObjectProperties(e.objects[0]):i.objectPropertyGrid.loadPageProperties()}),e.on(M.WBObjectDeselectedEvent.type,function(e){1===e.objects.length?i.objectPropertyGrid.loadObjectProperties(e.objects[0]):i.objectPropertyGrid.loadPageProperties()}),e.on(M.WBObjectMovedEvent.type,function(e){i.objectPropertyGrid.reloadObjectProperties()}),e.on(M.WBToolActivateEvent.type,function(e){i.toolPropertyGrid.loadToolProperties(e.tool),e.tool.name===M.WBSelectTool.toolname&&i.objectPropertyGrid.loadPageProperties()}),e.on(M.WBToolDeactivateEvent.type,function(e){i.toolPropertyGrid.clear(),e.tool.name===M.WBSelectTool.toolname&&i.objectPropertyGrid.loadPageProperties()}),y.App.run()}}),D=t(A),F=A.init;e.default=D,e.init=F,Object.defineProperty(e,"__esModule",{value:!0})});
